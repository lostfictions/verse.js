//verse.js
//2014 - 2015

/*global createjs */

'use strict';

var notes = ['e', 'f', 'f#', 'g', 'g#', 'a', 'a#', 'b', 'c', 'c#', 'd', 'd#', 'e', 'f', 'f#', 'g', 'g#', 'a', 'a#', 'b', 'c', 'c#', 'd', 'd#', 'e', 'f', 'f#', 'g', 'g#', 'a', 'a#', 'b', 'c', 'c#', 'd', 'd#', 'e'];

var config = {
  maxDotFactor: 60 / 500000,
  maxMouseDistance: 100,
  maxContactDistance: 50,
  contactTimeout: 400,
  contactVelocityFactor: 0.5,
  dotSpeedThreshold: 10,
  dotDeceleration: 0.99,
  fadeFactor: 0.05,
  chordChangeTimeout: 5000,
  dotAddRemoveTimeout: 100,
  noteTriggerTimeout: 50,
  chordList: ['e, c, g', 'e, b, g']
};

var audio = {
  actives: [],
  pool: []
};

var maxDotCount = 1;

var dots = [];

var lastMouse = {
  x: 0,
  y: 0
};

var chordChangeTimeout = 0;
var dotAddRemoveTimeout = 0;
var noteTriggerTimeout = 0;
var chordIndex = 0;
var scale = [];

var fadeRect = null;
var canvas = null;
var stage = null;
var drawingCanvas = null;

function init() {
  canvas = document.getElementById('mainCanvas');

  stage = new createjs.Stage(canvas);
  stage.autoClear = false;
  stage.enableDOMEvents(true);

  createjs.Touch.enable(stage);

  createjs.Ticker.timingMode = createjs.Ticker.RAF_SYNCHED;
  createjs.Ticker.setFPS(60);

  canvas.setAttribute('style', 'background-color: #000000');

  drawingCanvas = new createjs.Shape();
  stage.addChild(drawingCanvas);

  fadeRect = new createjs.Shape();
  stage.addChild(fadeRect);

  setChord(chordIndex);

  //audio stuff.
  window.AudioContext = window.AudioContext || window.webkitAudioContext;
  if (!window.AudioContext) {
    console.log('audio api not available!');
    //TODO: do something smart to handle the api not being available.
  } else {
    audio.ctx = new AudioContext();
  }

  window.addEventListener('resize', onResize);
  onResize();
  stage.addEventListener('stagemousemove', onMouseMove);
  createjs.Ticker.addEventListener('tick', onTick);
}

function onResize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  fadeRect.graphics.clear().beginFill('rgba(0,0,0,' + config.fadeFactor + ')').rect(0, 0, canvas.width, canvas.height);

  maxDotCount = Math.round(config.maxDotFactor * canvas.width * canvas.height);
  console.log('maxDotCount: ' + maxDotCount);
}

//TODO: should be okay to not use our delta time everywhere because our ticker
//mode is RAF_SYNCHED, but we should do it anyway.
function onTick(event) {
  tickTones(event.delta);
  chordChangeTimeout -= event.delta;
  dotAddRemoveTimeout -= event.delta;
  noteTriggerTimeout -= event.delta;

  var dMouseX = stage.mouseX - lastMouse.x;
  var dMouseY = stage.mouseY - lastMouse.y;

  if (dotAddRemoveTimeout < 0) {
    dotAddRemoveTimeout = config.dotAddRemoveTimeout;
    if (dots.length < maxDotCount) {
      addDot();
      console.log('adding... ' + dots.length);
    } else if (dots.length > maxDotCount) {
      dots.pop();
      console.log('removing... ' + dots.length);
    }
  }

  var g = drawingCanvas.graphics;

  g.clear().setStrokeStyle(1).beginStroke('#ffffff');

  var wasNotePlayed = false;

  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = dots[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      var dot = _step.value;

      g.moveTo(dot.x, dot.y);
      dot.x += dot.velocity.x;
      dot.y += dot.velocity.y;
      g.lineTo(dot.x, dot.y);

      wrapToStage(dot);

      dot.contactTimeout -= event.delta;

      var _iteratorNormalCompletion2 = true;
      var _didIteratorError2 = false;
      var _iteratorError2 = undefined;

      try {
        for (var _iterator2 = dots[Symbol.iterator](), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
          var otherDot = _step2.value;

          if (otherDot === dot) {
            continue;
          }

          var dx = dot.x - otherDot.x;
          var dy = dot.y - otherDot.y;
          var dist = Math.sqrt(dx * dx + dy * dy);

          if (dist > config.maxContactDistance) {
            continue;
          }

          if (dist > 0) {
            var vf = config.contactVelocityFactor;
            dot.velocity.x += vf * dx / dist;
            dot.velocity.y += vf * dy / dist;
            otherDot.velocity.x -= vf * dx / dist;
            otherDot.velocity.y -= vf * dy / dist;
          }

          if (dot.contactTimeout < 0) {
            dot.contactTimeout = config.contactTimeout;

            g.moveTo(dot.x, dot.y).lineTo(otherDot.x, otherDot.y);

            if (!wasNotePlayed && noteTriggerTimeout < 0) {
              wasNotePlayed = true;
              noteTriggerTimeout = config.noteTriggerTimeout;

              var avgYPos = (dot.y + otherDot.y) / 2;
              var indScale = Math.round(Math.random() * 2) * 2 - 1 + scale.length - 1 - Math.round(scale.length * avgYPos / canvas.height);
              indScale = clamp(indScale, 0, scale.length - 1);

              var avgXPos = (dot.x + otherDot.x) / 2;
              var pan = avgXPos / (canvas.width * 0.5) - 1;

              var avgXVel = (Math.abs(dot.velocity.x) + Math.abs(otherDot.velocity.x)) / 2;
              var avgYVel = (Math.abs(dot.velocity.y) + Math.abs(otherDot.velocity.y)) / 2;

              var avgVelocity = Math.sqrt(avgXVel * avgXVel + avgYVel * avgYVel);
              avgVelocity = clamp(avgVelocity, 0, config.dotSpeedThreshold);

              var volume = 0.2 + 0.8 * (avgVelocity / config.dotSpeedThreshold);

              var note = scale[indScale];

              addTone(note, pan, volume);
            }
          }
        }
      } catch (err) {
        _didIteratorError2 = true;
        _iteratorError2 = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion2 && _iterator2['return']) {
            _iterator2['return']();
          }
        } finally {
          if (_didIteratorError2) {
            throw _iteratorError2;
          }
        }
      }

      //done iterating through other dots.

      var dX = dot.x - stage.mouseX;
      var dY = dot.y - stage.mouseY;

      var distMouse = Math.sqrt(dX * dX + dY * dY);

      if (distMouse < config.maxMouseDistance) {
        dot.velocity.x += 0.001 * (config.maxMouseDistance - distMouse) * dMouseX;
        dot.velocity.y += 0.001 * (config.maxMouseDistance - distMouse) * dMouseY;
      }

      var speed = Math.sqrt(dot.velocity.x * dot.velocity.x + dot.velocity.y * dot.velocity.y);
      if (speed > config.dotSpeedThreshold) {
        dot.velocity.x = config.dotSpeedThreshold * dot.velocity.x / speed;
        dot.velocity.y = config.dotSpeedThreshold * dot.velocity.y / speed;
      }

      dot.velocity.x *= config.dotDeceleration;
      dot.velocity.y *= config.dotDeceleration;
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator['return']) {
        _iterator['return']();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }

  lastMouse.x = stage.mouseX;
  lastMouse.y = stage.mouseY;

  stage.update();
}

function tickTones(delta) {
  var toDequeue = 0;

  var _iteratorNormalCompletion3 = true;
  var _didIteratorError3 = false;
  var _iteratorError3 = undefined;

  try {
    for (var _iterator3 = audio.actives[Symbol.iterator](), _step3; !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
      var tone = _step3.value;

      tone.duration -= delta;

      if (tone.duration < 0) {
        //see hack below -- if we stop the oscillator, it seems to get GC'd in Firefox right now.
        tone.osc.stop(0);
        //tone.gain.gain.value = 0
        toDequeue++;
      } else {
        var frac = tone.duration / tone.initDuration * tone.volume;
        //let's use exponential instead of linear gain.
        tone.gain.gain.value = frac * frac;
      }
    }
  } catch (err) {
    _didIteratorError3 = true;
    _iteratorError3 = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion3 && _iterator3['return']) {
        _iterator3['return']();
      }
    } finally {
      if (_didIteratorError3) {
        throw _iteratorError3;
      }
    }
  }

  while (toDequeue > 0) {
    //actives should be ordered by duration, so we can just shift from the front to dequeue them.
    audio.actives.shift();
    //audio.pool.push()
    toDequeue--;
  }
}

//TODO: handle pan using a PannerNode
function addTone(note, pan, volume) {
  if (audio.actives.length > 8) {
    return;
  }
  //tone = audio.pool.pop()
  var tone = null;
  if (!tone) {
    var osc = audio.ctx.createOscillator();
    osc.type = 'sine';

    var gain = audio.ctx.createGain();
    osc.connect(gain);

    gain.connect(audio.ctx.destination);
    tone = {
      osc: osc,
      gain: gain
    };
    //HACK: start the oscillator on initialization and never stop it,
    //since it seems to get erroneously GC'd or messed up otherwise?
  }

  tone.duration = 1000;
  tone.initDuration = tone.duration;

  tone.volume = volume;
  tone.gain.gain.value = tone.volume;

  tone.osc.frequency.value = 440 * Math.pow(2, note / 12 - 1);

  tone.osc.start(0);

  audio.actives.push(tone);
}

function onMouseMove(event) {
  if (chordChangeTimeout < 0) {
    chordIndex = (chordIndex + 1) % config.chordList.length;
    setChord(chordIndex);
  }

  chordChangeTimeout = config.chordChangeTimeout;
}

function setChord(index) {
  var chordNotes = config.chordList[index];

  scale = [];

  notes.forEach(function (note, i) {
    if (chordNotes.indexOf(note) !== -1) {
      scale.push(i);
    }
  });
}

function addDot() {
  var dot = new createjs.Point(Math.random() * canvas.width, Math.random() * canvas.height);

  dot.velocity = new createjs.Point(0, 0);
  dot.contactTimeout = config.contactTimeout;

  dots.push(dot);
}

function wrapToStage(dot) {
  if (dot.x < 0) {
    dot.x += canvas.width;
  } else if (dot.x > canvas.width) {
    dot.x -= canvas.width;
  }
  if (dot.y < 0) {
    dot.y += canvas.height;
  } else if (dot.y > canvas.height) {
    dot.y -= canvas.height;
  }
}

function clamp(val, min, max) {
  return Math.max(min, Math.min(max, val));
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZlcnNlMi5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBS0EsSUFBTSxLQUFLLEdBQUcsQ0FDWixHQUFHLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUN6QixHQUFHLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUN6QixHQUFHLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUN6QixHQUFHLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUN6QixHQUFHLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUN6QixHQUFHLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUN6QixJQUFJLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUN6QixJQUFJLEVBQUUsR0FBRyxDQUNWLENBQUM7O0FBRUYsSUFBTSxNQUFNLEdBQUc7QUFDYixjQUFZLEVBQUUsRUFBRSxHQUFHLE1BQU07QUFDekIsa0JBQWdCLEVBQUUsR0FBRztBQUNyQixvQkFBa0IsRUFBRSxFQUFFO0FBQ3RCLGdCQUFjLEVBQUUsR0FBRztBQUNuQix1QkFBcUIsRUFBRSxHQUFHO0FBQzFCLG1CQUFpQixFQUFFLEVBQUU7QUFDckIsaUJBQWUsRUFBRSxJQUFJO0FBQ3JCLFlBQVUsRUFBRSxJQUFJO0FBQ2hCLG9CQUFrQixFQUFFLElBQUk7QUFDeEIscUJBQW1CLEVBQUUsR0FBRztBQUN4QixvQkFBa0IsRUFBRSxFQUFFO0FBQ3RCLFdBQVMsRUFBRSxDQUFDLFNBQVMsRUFBRSxTQUFTLENBQUM7Q0FDbEMsQ0FBQzs7QUFFRixJQUFJLEtBQUssR0FBRztBQUNWLFNBQU8sRUFBRSxFQUFFO0FBQ1gsTUFBSSxFQUFFLEVBQUU7Q0FDVCxDQUFDOztBQUVGLElBQUksV0FBVyxHQUFHLENBQUMsQ0FBQzs7QUFFcEIsSUFBSSxJQUFJLEdBQUcsRUFBRSxDQUFDOztBQUVkLElBQUksU0FBUyxHQUFHO0FBQ2QsR0FBQyxFQUFFLENBQUM7QUFDSixHQUFDLEVBQUUsQ0FBQztDQUNMLENBQUM7O0FBRUYsSUFBSSxrQkFBa0IsR0FBRyxDQUFDLENBQUM7QUFDM0IsSUFBSSxtQkFBbUIsR0FBRyxDQUFDLENBQUM7QUFDNUIsSUFBSSxrQkFBa0IsR0FBRyxDQUFDLENBQUM7QUFDM0IsSUFBSSxVQUFVLEdBQUcsQ0FBQyxDQUFDO0FBQ25CLElBQUksS0FBSyxHQUFHLEVBQUUsQ0FBQzs7QUFFZixJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUM7QUFDcEIsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDO0FBQ2xCLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQztBQUNqQixJQUFJLGFBQWEsR0FBRyxJQUFJLENBQUM7O0FBRXpCLFNBQVMsSUFBSSxHQUFHO0FBQ2QsUUFBTSxHQUFHLFFBQVEsQ0FBQyxjQUFjLENBQUMsWUFBWSxDQUFDLENBQUM7O0FBRS9DLE9BQUssR0FBRyxJQUFJLFFBQVEsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDbkMsT0FBSyxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7QUFDeEIsT0FBSyxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQzs7QUFFNUIsVUFBUSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7O0FBRTdCLFVBQVEsQ0FBQyxNQUFNLENBQUMsVUFBVSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDO0FBQ3pELFVBQVEsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDOztBQUUzQixRQUFNLENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRSwyQkFBMkIsQ0FBQyxDQUFDOztBQUUxRCxlQUFhLEdBQUcsSUFBSSxRQUFRLENBQUMsS0FBSyxFQUFFLENBQUM7QUFDckMsT0FBSyxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsQ0FBQzs7QUFFOUIsVUFBUSxHQUFHLElBQUksUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFDO0FBQ2hDLE9BQUssQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUM7O0FBRXpCLFVBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQzs7O0FBR3JCLFFBQU0sQ0FBQyxZQUFZLEdBQUcsTUFBTSxDQUFDLFlBQVksSUFBSSxNQUFNLENBQUMsa0JBQWtCLENBQUM7QUFDdkUsTUFBRyxDQUFDLE1BQU0sQ0FBQyxZQUFZLEVBQUU7QUFDdkIsV0FBTyxDQUFDLEdBQUcsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDOztHQUV6QyxNQUNJO0FBQ0gsU0FBSyxDQUFDLEdBQUcsR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO0dBQ2hDOztBQUVELFFBQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsUUFBUSxDQUFDLENBQUM7QUFDNUMsVUFBUSxFQUFFLENBQUM7QUFDWCxPQUFLLENBQUMsZ0JBQWdCLENBQUMsZ0JBQWdCLEVBQUUsV0FBVyxDQUFDLENBQUM7QUFDdEQsVUFBUSxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7Q0FDbEQ7O0FBRUQsU0FBUyxRQUFRLEdBQUc7QUFDbEIsUUFBTSxDQUFDLEtBQUssR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDO0FBQ2pDLFFBQU0sQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQztBQUNuQyxVQUFRLENBQUMsUUFBUSxDQUNkLEtBQUssRUFBRSxDQUNQLFNBQVMsaUJBQWdCLE1BQU0sQ0FBQyxVQUFVLE9BQUssQ0FDL0MsSUFBSSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsTUFBTSxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7O0FBRTNDLGFBQVcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxZQUFZLEdBQUcsTUFBTSxDQUFDLEtBQUssR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDN0UsU0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLEdBQUcsV0FBVyxDQUFDLENBQUM7Q0FDNUM7Ozs7QUFJRCxTQUFTLE1BQU0sQ0FBQyxLQUFLLEVBQUU7QUFDckIsV0FBUyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUN2QixvQkFBa0IsSUFBSSxLQUFLLENBQUMsS0FBSyxDQUFDO0FBQ2xDLHFCQUFtQixJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUM7QUFDbkMsb0JBQWtCLElBQUksS0FBSyxDQUFDLEtBQUssQ0FBQzs7QUFFbEMsTUFBTSxPQUFPLEdBQUcsS0FBSyxDQUFDLE1BQU0sR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDO0FBQzNDLE1BQU0sT0FBTyxHQUFHLEtBQUssQ0FBQyxNQUFNLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQzs7QUFFM0MsTUFBRyxtQkFBbUIsR0FBRyxDQUFDLEVBQUU7QUFDMUIsdUJBQW1CLEdBQUcsTUFBTSxDQUFDLG1CQUFtQixDQUFDO0FBQ2pELFFBQUcsSUFBSSxDQUFDLE1BQU0sR0FBRyxXQUFXLEVBQUM7QUFDM0IsWUFBTSxFQUFFLENBQUM7QUFDVCxhQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7S0FDekMsTUFDSSxJQUFHLElBQUksQ0FBQyxNQUFNLEdBQUcsV0FBVyxFQUFDO0FBQ2hDLFVBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUNYLGFBQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztLQUMzQztHQUNGOztBQUVELE1BQU0sQ0FBQyxHQUFHLGFBQWEsQ0FBQyxRQUFRLENBQUM7O0FBRWpDLEdBQUMsQ0FDRSxLQUFLLEVBQUUsQ0FDUCxjQUFjLENBQUMsQ0FBQyxDQUFDLENBQ2pCLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQzs7QUFHMUIsTUFBSSxhQUFhLEdBQUcsS0FBSyxDQUFDOzs7Ozs7O0FBRTFCLHlCQUFlLElBQUksOEhBQUU7VUFBYixHQUFHOztBQUNULE9BQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDdkIsU0FBRyxDQUFDLENBQUMsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztBQUN4QixTQUFHLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO0FBQ3hCLE9BQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7O0FBRXZCLGlCQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7O0FBRWpCLFNBQUcsQ0FBQyxjQUFjLElBQUksS0FBSyxDQUFDLEtBQUssQ0FBQzs7Ozs7OztBQUVsQyw4QkFBb0IsSUFBSSxtSUFBRTtjQUFsQixRQUFROztBQUNkLGNBQUcsUUFBUSxLQUFLLEdBQUcsRUFBRTtBQUNuQixxQkFBUztXQUNWOztBQUVELGNBQU0sRUFBRSxHQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQztBQUM5QixjQUFNLEVBQUUsR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUM7QUFDOUIsY0FBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQzs7QUFFMUMsY0FBRyxJQUFJLEdBQUcsTUFBTSxDQUFDLGtCQUFrQixFQUFFO0FBQ25DLHFCQUFTO1dBQ1Y7O0FBRUQsY0FBRyxJQUFJLEdBQUcsQ0FBQyxFQUFFO0FBQ1gsZ0JBQU0sRUFBRSxHQUFHLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQztBQUN4QyxlQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQztBQUNqQyxlQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQztBQUNqQyxvQkFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUM7QUFDdEMsb0JBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDO1dBQ3ZDOztBQUVELGNBQUcsR0FBRyxDQUFDLGNBQWMsR0FBRyxDQUFDLEVBQUU7QUFDekIsZUFBRyxDQUFDLGNBQWMsR0FBRyxNQUFNLENBQUMsY0FBYyxDQUFDOztBQUUzQyxhQUFDLENBQ0UsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUNwQixNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7O0FBRWxDLGdCQUFHLENBQUMsYUFBYSxJQUFJLGtCQUFrQixHQUFHLENBQUMsRUFBRTtBQUMzQywyQkFBYSxHQUFHLElBQUksQ0FBQztBQUNyQixnQ0FBa0IsR0FBRyxNQUFNLENBQUMsa0JBQWtCLENBQUM7O0FBRS9DLGtCQUFNLE9BQU8sR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQSxHQUFJLENBQUMsQ0FBQztBQUN6QyxrQkFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFFLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsT0FBTyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUM5SCxzQkFBUSxHQUFHLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQyxFQUFFLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7O0FBRWhELGtCQUFNLE9BQU8sR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQSxHQUFJLENBQUMsQ0FBQztBQUN6QyxrQkFBTSxHQUFHLEdBQUcsT0FBTyxJQUFJLE1BQU0sQ0FBQyxLQUFLLEdBQUcsR0FBRyxDQUFBLEFBQUMsR0FBRyxDQUFDLENBQUM7O0FBRS9DLGtCQUFNLE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUEsR0FBSSxDQUFDLENBQUM7QUFDL0Usa0JBQU0sT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQSxHQUFJLENBQUMsQ0FBQzs7QUFFL0Usa0JBQUksV0FBVyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sR0FBRyxPQUFPLEdBQUcsT0FBTyxDQUFDLENBQUM7QUFDbkUseUJBQVcsR0FBRyxLQUFLLENBQUMsV0FBVyxFQUFFLENBQUMsRUFBRSxNQUFNLENBQUMsaUJBQWlCLENBQUMsQ0FBQzs7QUFFOUQsa0JBQU0sTUFBTSxHQUFHLEdBQUcsR0FBRyxHQUFHLElBQUksV0FBVyxHQUFHLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQSxBQUFDLENBQUM7O0FBRXBFLGtCQUFNLElBQUksR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7O0FBRTdCLHFCQUFPLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxNQUFNLENBQUMsQ0FBQzthQUM1QjtXQUNGO1NBQ0Y7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVELFVBQU0sRUFBRSxHQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQztBQUNoQyxVQUFNLEVBQUUsR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUM7O0FBRWhDLFVBQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7O0FBRS9DLFVBQUcsU0FBUyxHQUFHLE1BQU0sQ0FBQyxnQkFBZ0IsRUFBRTtBQUN0QyxXQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxLQUFLLElBQUksTUFBTSxDQUFDLGdCQUFnQixHQUFHLFNBQVMsQ0FBQSxBQUFDLEdBQUcsT0FBTyxDQUFDO0FBQzFFLFdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLEtBQUssSUFBSSxNQUFNLENBQUMsZ0JBQWdCLEdBQUcsU0FBUyxDQUFBLEFBQUMsR0FBRyxPQUFPLENBQUM7T0FDM0U7O0FBRUQsVUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzNGLFVBQUcsS0FBSyxHQUFHLE1BQU0sQ0FBQyxpQkFBaUIsRUFBRTtBQUNuQyxXQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsaUJBQWlCLEdBQUcsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDO0FBQ25FLFdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxpQkFBaUIsR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUM7T0FDcEU7O0FBRUQsU0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksTUFBTSxDQUFDLGVBQWUsQ0FBQztBQUN6QyxTQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxNQUFNLENBQUMsZUFBZSxDQUFDO0tBRTFDOzs7Ozs7Ozs7Ozs7Ozs7O0FBRUQsV0FBUyxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDO0FBQzNCLFdBQVMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQzs7QUFFM0IsT0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDO0NBQ2hCOztBQUdELFNBQVMsU0FBUyxDQUFDLEtBQUssRUFBRTtBQUN4QixNQUFJLFNBQVMsR0FBRyxDQUFDLENBQUM7Ozs7Ozs7QUFFbEIsMEJBQWdCLEtBQUssQ0FBQyxPQUFPLG1JQUFFO1VBQXZCLElBQUk7O0FBQ1YsVUFBSSxDQUFDLFFBQVEsSUFBSSxLQUFLLENBQUM7O0FBRXZCLFVBQUcsSUFBSSxDQUFDLFFBQVEsR0FBRyxDQUFDLEVBQUU7O0FBRXBCLFlBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDOztBQUVqQixpQkFBUyxFQUFFLENBQUM7T0FDYixNQUNJO0FBQ0gsWUFBTSxJQUFJLEdBQUcsQUFBQyxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxZQUFZLEdBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQzs7QUFFL0QsWUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksR0FBRyxJQUFJLENBQUM7T0FDcEM7S0FDRjs7Ozs7Ozs7Ozs7Ozs7OztBQUVELFNBQU0sU0FBUyxHQUFHLENBQUMsRUFBRTs7QUFFbkIsU0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQzs7QUFFdEIsYUFBUyxFQUFFLENBQUM7R0FDYjtDQUNGOzs7QUFHRCxTQUFTLE9BQU8sQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRTtBQUNsQyxNQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtBQUMzQixXQUFPO0dBQ1I7O0FBRUQsTUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDO0FBQ2hCLE1BQUcsQ0FBQyxJQUFJLEVBQUU7QUFDUixRQUFNLEdBQUcsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLGdCQUFnQixFQUFFLENBQUM7QUFDekMsT0FBRyxDQUFDLElBQUksR0FBRyxNQUFNLENBQUM7O0FBRWxCLFFBQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLENBQUM7QUFDcEMsT0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQzs7QUFFbEIsUUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBQ3BDLFFBQUksR0FBRztBQUNMLFNBQUcsRUFBRSxHQUFHO0FBQ1IsVUFBSSxFQUFFLElBQUk7S0FDWCxDQUFDOzs7R0FHSDs7QUFFRCxNQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztBQUNyQixNQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7O0FBRWxDLE1BQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO0FBQ3JCLE1BQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDOztBQUVuQyxNQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxLQUFLLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLEFBQUMsSUFBSSxHQUFHLEVBQUUsR0FBSSxDQUFDLENBQUMsQ0FBQzs7QUFFOUQsTUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7O0FBRWxCLE9BQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0NBQzFCOztBQUVELFNBQVMsV0FBVyxDQUFDLEtBQUssRUFBRTtBQUMxQixNQUFHLGtCQUFrQixHQUFHLENBQUMsRUFBRTtBQUN6QixjQUFVLEdBQUcsQ0FBQyxVQUFVLEdBQUcsQ0FBQyxDQUFBLEdBQUksTUFBTSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUM7QUFDeEQsWUFBUSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0dBQ3RCOztBQUVELG9CQUFrQixHQUFHLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQztDQUNoRDs7QUFFRCxTQUFTLFFBQVEsQ0FBQyxLQUFLLEVBQUU7QUFDdkIsTUFBTSxVQUFVLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQzs7QUFFM0MsT0FBSyxHQUFHLEVBQUUsQ0FBQzs7QUFFWCxPQUFLLENBQUMsT0FBTyxDQUFDLFVBQUMsSUFBSSxFQUFFLENBQUMsRUFBSztBQUN6QixRQUFHLFVBQVUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7QUFDbEMsV0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUNmO0dBQ0YsQ0FBQyxDQUFDO0NBQ0o7O0FBRUQsU0FBUyxNQUFNLEdBQUc7QUFDaEIsTUFBTSxHQUFHLEdBQUcsSUFBSSxRQUFRLENBQUMsS0FBSyxDQUM1QixJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsTUFBTSxDQUFDLEtBQUssRUFDNUIsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQzlCLENBQUM7O0FBRUYsS0FBRyxDQUFDLFFBQVEsR0FBRyxJQUFJLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQ3hDLEtBQUcsQ0FBQyxjQUFjLEdBQUcsTUFBTSxDQUFDLGNBQWMsQ0FBQzs7QUFFM0MsTUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztDQUNoQjs7QUFFRCxTQUFTLFdBQVcsQ0FBQyxHQUFHLEVBQUU7QUFDeEIsTUFBSSxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRTtBQUNiLE9BQUcsQ0FBQyxDQUFDLElBQUksTUFBTSxDQUFDLEtBQUssQ0FBQztHQUN2QixNQUNJLElBQUksR0FBRyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsS0FBSyxFQUFFO0FBQzdCLE9BQUcsQ0FBQyxDQUFDLElBQUksTUFBTSxDQUFDLEtBQUssQ0FBQztHQUN2QjtBQUNELE1BQUksR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUU7QUFDYixPQUFHLENBQUMsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUM7R0FDeEIsTUFDSSxJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUcsTUFBTSxDQUFDLE1BQU0sRUFBRTtBQUM5QixPQUFHLENBQUMsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUM7R0FDeEI7Q0FDRjs7QUFFRCxTQUFTLEtBQUssQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRTtBQUM1QixTQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7Q0FDMUMiLCJmaWxlIjoidmVyc2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvL3ZlcnNlLmpzXG4vLzIwMTQgLSAyMDE1XG5cbi8qZ2xvYmFsIGNyZWF0ZWpzICovXG5cbmNvbnN0IG5vdGVzID0gW1xuICAnZScsICdmJywgJ2YjJywgJ2cnLCAnZyMnLFxuICAnYScsICdhIycsICdiJywgJ2MnLCAnYyMnLFxuICAnZCcsICdkIycsICdlJywgJ2YnLCAnZiMnLFxuICAnZycsICdnIycsICdhJywgJ2EjJywgJ2InLFxuICAnYycsICdjIycsICdkJywgJ2QjJywgJ2UnLFxuICAnZicsICdmIycsICdnJywgJ2cjJywgJ2EnLFxuICAnYSMnLCAnYicsICdjJywgJ2MjJywgJ2QnLFxuICAnZCMnLCAnZSdcbl07XG5cbmNvbnN0IGNvbmZpZyA9IHtcbiAgbWF4RG90RmFjdG9yOiA2MCAvIDUwMDAwMCxcbiAgbWF4TW91c2VEaXN0YW5jZTogMTAwLFxuICBtYXhDb250YWN0RGlzdGFuY2U6IDUwLFxuICBjb250YWN0VGltZW91dDogNDAwLFxuICBjb250YWN0VmVsb2NpdHlGYWN0b3I6IDAuNSxcbiAgZG90U3BlZWRUaHJlc2hvbGQ6IDEwLFxuICBkb3REZWNlbGVyYXRpb246IDAuOTksXG4gIGZhZGVGYWN0b3I6IDAuMDUsXG4gIGNob3JkQ2hhbmdlVGltZW91dDogNTAwMCxcbiAgZG90QWRkUmVtb3ZlVGltZW91dDogMTAwLFxuICBub3RlVHJpZ2dlclRpbWVvdXQ6IDUwLFxuICBjaG9yZExpc3Q6IFsnZSwgYywgZycsICdlLCBiLCBnJ11cbn07XG5cbmxldCBhdWRpbyA9IHtcbiAgYWN0aXZlczogW10sXG4gIHBvb2w6IFtdXG59O1xuXG5sZXQgbWF4RG90Q291bnQgPSAxO1xuXG5sZXQgZG90cyA9IFtdO1xuXG5sZXQgbGFzdE1vdXNlID0ge1xuICB4OiAwLFxuICB5OiAwXG59O1xuXG5sZXQgY2hvcmRDaGFuZ2VUaW1lb3V0ID0gMDtcbmxldCBkb3RBZGRSZW1vdmVUaW1lb3V0ID0gMDtcbmxldCBub3RlVHJpZ2dlclRpbWVvdXQgPSAwO1xubGV0IGNob3JkSW5kZXggPSAwO1xubGV0IHNjYWxlID0gW107XG5cbmxldCBmYWRlUmVjdCA9IG51bGw7XG5sZXQgY2FudmFzID0gbnVsbDtcbmxldCBzdGFnZSA9IG51bGw7XG5sZXQgZHJhd2luZ0NhbnZhcyA9IG51bGw7XG5cbmZ1bmN0aW9uIGluaXQoKSB7XG4gIGNhbnZhcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYWluQ2FudmFzJyk7XG5cbiAgc3RhZ2UgPSBuZXcgY3JlYXRlanMuU3RhZ2UoY2FudmFzKTtcbiAgc3RhZ2UuYXV0b0NsZWFyID0gZmFsc2U7XG4gIHN0YWdlLmVuYWJsZURPTUV2ZW50cyh0cnVlKTtcblxuICBjcmVhdGVqcy5Ub3VjaC5lbmFibGUoc3RhZ2UpO1xuXG4gIGNyZWF0ZWpzLlRpY2tlci50aW1pbmdNb2RlID0gY3JlYXRlanMuVGlja2VyLlJBRl9TWU5DSEVEO1xuICBjcmVhdGVqcy5UaWNrZXIuc2V0RlBTKDYwKTtcblxuICBjYW52YXMuc2V0QXR0cmlidXRlKCdzdHlsZScsICdiYWNrZ3JvdW5kLWNvbG9yOiAjMDAwMDAwJyk7XG5cbiAgZHJhd2luZ0NhbnZhcyA9IG5ldyBjcmVhdGVqcy5TaGFwZSgpO1xuICBzdGFnZS5hZGRDaGlsZChkcmF3aW5nQ2FudmFzKTtcblxuICBmYWRlUmVjdCA9IG5ldyBjcmVhdGVqcy5TaGFwZSgpO1xuICBzdGFnZS5hZGRDaGlsZChmYWRlUmVjdCk7XG5cbiAgc2V0Q2hvcmQoY2hvcmRJbmRleCk7XG5cbiAgLy9hdWRpbyBzdHVmZi5cbiAgd2luZG93LkF1ZGlvQ29udGV4dCA9IHdpbmRvdy5BdWRpb0NvbnRleHQgfHwgd2luZG93LndlYmtpdEF1ZGlvQ29udGV4dDtcbiAgaWYoIXdpbmRvdy5BdWRpb0NvbnRleHQpIHtcbiAgICBjb25zb2xlLmxvZygnYXVkaW8gYXBpIG5vdCBhdmFpbGFibGUhJyk7XG4gICAgLy9UT0RPOiBkbyBzb21ldGhpbmcgc21hcnQgdG8gaGFuZGxlIHRoZSBhcGkgbm90IGJlaW5nIGF2YWlsYWJsZS5cbiAgfVxuICBlbHNlIHtcbiAgICBhdWRpby5jdHggPSBuZXcgQXVkaW9Db250ZXh0KCk7XG4gIH1cblxuICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncmVzaXplJywgb25SZXNpemUpO1xuICBvblJlc2l6ZSgpO1xuICBzdGFnZS5hZGRFdmVudExpc3RlbmVyKCdzdGFnZW1vdXNlbW92ZScsIG9uTW91c2VNb3ZlKTtcbiAgY3JlYXRlanMuVGlja2VyLmFkZEV2ZW50TGlzdGVuZXIoJ3RpY2snLCBvblRpY2spO1xufVxuXG5mdW5jdGlvbiBvblJlc2l6ZSgpIHtcbiAgY2FudmFzLndpZHRoID0gd2luZG93LmlubmVyV2lkdGg7XG4gIGNhbnZhcy5oZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQ7XG4gIGZhZGVSZWN0LmdyYXBoaWNzXG4gICAgLmNsZWFyKClcbiAgICAuYmVnaW5GaWxsKGByZ2JhKDAsMCwwLCR7IGNvbmZpZy5mYWRlRmFjdG9yIH0pYClcbiAgICAucmVjdCgwLCAwLCBjYW52YXMud2lkdGgsIGNhbnZhcy5oZWlnaHQpO1xuXG4gIG1heERvdENvdW50ID0gTWF0aC5yb3VuZChjb25maWcubWF4RG90RmFjdG9yICogY2FudmFzLndpZHRoICogY2FudmFzLmhlaWdodCk7XG4gIGNvbnNvbGUubG9nKCdtYXhEb3RDb3VudDogJyArIG1heERvdENvdW50KTtcbn1cblxuLy9UT0RPOiBzaG91bGQgYmUgb2theSB0byBub3QgdXNlIG91ciBkZWx0YSB0aW1lIGV2ZXJ5d2hlcmUgYmVjYXVzZSBvdXIgdGlja2VyXG4vL21vZGUgaXMgUkFGX1NZTkNIRUQsIGJ1dCB3ZSBzaG91bGQgZG8gaXQgYW55d2F5LlxuZnVuY3Rpb24gb25UaWNrKGV2ZW50KSB7XG4gIHRpY2tUb25lcyhldmVudC5kZWx0YSk7XG4gIGNob3JkQ2hhbmdlVGltZW91dCAtPSBldmVudC5kZWx0YTtcbiAgZG90QWRkUmVtb3ZlVGltZW91dCAtPSBldmVudC5kZWx0YTtcbiAgbm90ZVRyaWdnZXJUaW1lb3V0IC09IGV2ZW50LmRlbHRhO1xuXG4gIGNvbnN0IGRNb3VzZVggPSBzdGFnZS5tb3VzZVggLSBsYXN0TW91c2UueDtcbiAgY29uc3QgZE1vdXNlWSA9IHN0YWdlLm1vdXNlWSAtIGxhc3RNb3VzZS55O1xuXG4gIGlmKGRvdEFkZFJlbW92ZVRpbWVvdXQgPCAwKSB7XG4gICAgZG90QWRkUmVtb3ZlVGltZW91dCA9IGNvbmZpZy5kb3RBZGRSZW1vdmVUaW1lb3V0O1xuICAgIGlmKGRvdHMubGVuZ3RoIDwgbWF4RG90Q291bnQpe1xuICAgICAgYWRkRG90KCk7XG4gICAgICBjb25zb2xlLmxvZygnYWRkaW5nLi4uICcgKyBkb3RzLmxlbmd0aCk7XG4gICAgfVxuICAgIGVsc2UgaWYoZG90cy5sZW5ndGggPiBtYXhEb3RDb3VudCl7XG4gICAgICBkb3RzLnBvcCgpO1xuICAgICAgY29uc29sZS5sb2coJ3JlbW92aW5nLi4uICcgKyBkb3RzLmxlbmd0aCk7XG4gICAgfVxuICB9XG5cbiAgY29uc3QgZyA9IGRyYXdpbmdDYW52YXMuZ3JhcGhpY3M7XG5cbiAgZ1xuICAgIC5jbGVhcigpXG4gICAgLnNldFN0cm9rZVN0eWxlKDEpXG4gICAgLmJlZ2luU3Ryb2tlKCcjZmZmZmZmJyk7XG5cblxuICBsZXQgd2FzTm90ZVBsYXllZCA9IGZhbHNlO1xuXG4gIGZvcihsZXQgZG90IG9mIGRvdHMpIHtcbiAgICBnLm1vdmVUbyhkb3QueCwgZG90LnkpO1xuICAgIGRvdC54ICs9IGRvdC52ZWxvY2l0eS54O1xuICAgIGRvdC55ICs9IGRvdC52ZWxvY2l0eS55O1xuICAgIGcubGluZVRvKGRvdC54LCBkb3QueSk7XG5cbiAgICB3cmFwVG9TdGFnZShkb3QpO1xuXG4gICAgZG90LmNvbnRhY3RUaW1lb3V0IC09IGV2ZW50LmRlbHRhO1xuXG4gICAgZm9yKGxldCBvdGhlckRvdCBvZiBkb3RzKSB7XG4gICAgICBpZihvdGhlckRvdCA9PT0gZG90KSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBkeCA9IGRvdC54IC0gb3RoZXJEb3QueDtcbiAgICAgIGNvbnN0IGR5ID0gZG90LnkgLSBvdGhlckRvdC55O1xuICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCAqIGR4ICsgZHkgKiBkeSk7XG5cbiAgICAgIGlmKGRpc3QgPiBjb25maWcubWF4Q29udGFjdERpc3RhbmNlKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBpZihkaXN0ID4gMCkge1xuICAgICAgICBjb25zdCB2ZiA9IGNvbmZpZy5jb250YWN0VmVsb2NpdHlGYWN0b3I7XG4gICAgICAgIGRvdC52ZWxvY2l0eS54ICs9IHZmICogZHggLyBkaXN0O1xuICAgICAgICBkb3QudmVsb2NpdHkueSArPSB2ZiAqIGR5IC8gZGlzdDtcbiAgICAgICAgb3RoZXJEb3QudmVsb2NpdHkueCAtPSB2ZiAqIGR4IC8gZGlzdDtcbiAgICAgICAgb3RoZXJEb3QudmVsb2NpdHkueSAtPSB2ZiAqIGR5IC8gZGlzdDtcbiAgICAgIH1cblxuICAgICAgaWYoZG90LmNvbnRhY3RUaW1lb3V0IDwgMCkge1xuICAgICAgICBkb3QuY29udGFjdFRpbWVvdXQgPSBjb25maWcuY29udGFjdFRpbWVvdXQ7XG5cbiAgICAgICAgZ1xuICAgICAgICAgIC5tb3ZlVG8oZG90LngsIGRvdC55KVxuICAgICAgICAgIC5saW5lVG8ob3RoZXJEb3QueCwgb3RoZXJEb3QueSk7XG5cbiAgICAgICAgaWYoIXdhc05vdGVQbGF5ZWQgJiYgbm90ZVRyaWdnZXJUaW1lb3V0IDwgMCkge1xuICAgICAgICAgIHdhc05vdGVQbGF5ZWQgPSB0cnVlO1xuICAgICAgICAgIG5vdGVUcmlnZ2VyVGltZW91dCA9IGNvbmZpZy5ub3RlVHJpZ2dlclRpbWVvdXQ7XG5cbiAgICAgICAgICBjb25zdCBhdmdZUG9zID0gKGRvdC55ICsgb3RoZXJEb3QueSkgLyAyO1xuICAgICAgICAgIGxldCBpbmRTY2FsZSA9IE1hdGgucm91bmQoTWF0aC5yYW5kb20oKSAqIDIgKSAqIDIgLSAxICsgc2NhbGUubGVuZ3RoIC0gMSAtIE1hdGgucm91bmQoc2NhbGUubGVuZ3RoICogYXZnWVBvcyAvIGNhbnZhcy5oZWlnaHQpO1xuICAgICAgICAgIGluZFNjYWxlID0gY2xhbXAoaW5kU2NhbGUsIDAsIHNjYWxlLmxlbmd0aCAtIDEpO1xuXG4gICAgICAgICAgY29uc3QgYXZnWFBvcyA9IChkb3QueCArIG90aGVyRG90LngpIC8gMjtcbiAgICAgICAgICBjb25zdCBwYW4gPSBhdmdYUG9zIC8gKGNhbnZhcy53aWR0aCAqIDAuNSkgLSAxO1xuXG4gICAgICAgICAgY29uc3QgYXZnWFZlbCA9IChNYXRoLmFicyhkb3QudmVsb2NpdHkueCkgKyBNYXRoLmFicyhvdGhlckRvdC52ZWxvY2l0eS54KSkgLyAyO1xuICAgICAgICAgIGNvbnN0IGF2Z1lWZWwgPSAoTWF0aC5hYnMoZG90LnZlbG9jaXR5LnkpICsgTWF0aC5hYnMob3RoZXJEb3QudmVsb2NpdHkueSkpIC8gMjtcblxuICAgICAgICAgIGxldCBhdmdWZWxvY2l0eSA9IE1hdGguc3FydChhdmdYVmVsICogYXZnWFZlbCArIGF2Z1lWZWwgKiBhdmdZVmVsKTtcbiAgICAgICAgICBhdmdWZWxvY2l0eSA9IGNsYW1wKGF2Z1ZlbG9jaXR5LCAwLCBjb25maWcuZG90U3BlZWRUaHJlc2hvbGQpO1xuXG4gICAgICAgICAgY29uc3Qgdm9sdW1lID0gMC4yICsgMC44ICogKGF2Z1ZlbG9jaXR5IC8gY29uZmlnLmRvdFNwZWVkVGhyZXNob2xkKTtcblxuICAgICAgICAgIGNvbnN0IG5vdGUgPSBzY2FsZVtpbmRTY2FsZV07XG5cbiAgICAgICAgICBhZGRUb25lKG5vdGUsIHBhbiwgdm9sdW1lKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gLy9kb25lIGl0ZXJhdGluZyB0aHJvdWdoIG90aGVyIGRvdHMuXG5cbiAgICBjb25zdCBkWCA9IGRvdC54IC0gc3RhZ2UubW91c2VYO1xuICAgIGNvbnN0IGRZID0gZG90LnkgLSBzdGFnZS5tb3VzZVk7XG5cbiAgICBjb25zdCBkaXN0TW91c2UgPSBNYXRoLnNxcnQoZFggKiBkWCArIGRZICogZFkpO1xuXG4gICAgaWYoZGlzdE1vdXNlIDwgY29uZmlnLm1heE1vdXNlRGlzdGFuY2UpIHtcbiAgICAgIGRvdC52ZWxvY2l0eS54ICs9IDAuMDAxICogKGNvbmZpZy5tYXhNb3VzZURpc3RhbmNlIC0gZGlzdE1vdXNlKSAqIGRNb3VzZVg7XG4gICAgICBkb3QudmVsb2NpdHkueSArPSAwLjAwMSAqIChjb25maWcubWF4TW91c2VEaXN0YW5jZSAtIGRpc3RNb3VzZSkgKiBkTW91c2VZO1xuICAgIH1cblxuICAgIGNvbnN0IHNwZWVkID0gTWF0aC5zcXJ0KGRvdC52ZWxvY2l0eS54ICogZG90LnZlbG9jaXR5LnggKyBkb3QudmVsb2NpdHkueSAqIGRvdC52ZWxvY2l0eS55KTtcbiAgICBpZihzcGVlZCA+IGNvbmZpZy5kb3RTcGVlZFRocmVzaG9sZCkge1xuICAgICAgZG90LnZlbG9jaXR5LnggPSBjb25maWcuZG90U3BlZWRUaHJlc2hvbGQgKiBkb3QudmVsb2NpdHkueCAvIHNwZWVkO1xuICAgICAgZG90LnZlbG9jaXR5LnkgPSBjb25maWcuZG90U3BlZWRUaHJlc2hvbGQgKiBkb3QudmVsb2NpdHkueSAvIHNwZWVkO1xuICAgIH1cblxuICAgIGRvdC52ZWxvY2l0eS54ICo9IGNvbmZpZy5kb3REZWNlbGVyYXRpb247XG4gICAgZG90LnZlbG9jaXR5LnkgKj0gY29uZmlnLmRvdERlY2VsZXJhdGlvbjtcblxuICB9XG5cbiAgbGFzdE1vdXNlLnggPSBzdGFnZS5tb3VzZVg7XG4gIGxhc3RNb3VzZS55ID0gc3RhZ2UubW91c2VZO1xuXG4gIHN0YWdlLnVwZGF0ZSgpO1xufVxuXG5cbmZ1bmN0aW9uIHRpY2tUb25lcyhkZWx0YSkge1xuICBsZXQgdG9EZXF1ZXVlID0gMDtcblxuICBmb3IobGV0IHRvbmUgb2YgYXVkaW8uYWN0aXZlcykge1xuICAgIHRvbmUuZHVyYXRpb24gLT0gZGVsdGE7XG5cbiAgICBpZih0b25lLmR1cmF0aW9uIDwgMCkge1xuICAgICAgLy9zZWUgaGFjayBiZWxvdyAtLSBpZiB3ZSBzdG9wIHRoZSBvc2NpbGxhdG9yLCBpdCBzZWVtcyB0byBnZXQgR0MnZCBpbiBGaXJlZm94IHJpZ2h0IG5vdy5cbiAgICAgIHRvbmUub3NjLnN0b3AoMCk7XG4gICAgICAvL3RvbmUuZ2Fpbi5nYWluLnZhbHVlID0gMFxuICAgICAgdG9EZXF1ZXVlKys7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgY29uc3QgZnJhYyA9ICh0b25lLmR1cmF0aW9uIC8gdG9uZS5pbml0RHVyYXRpb24pICogdG9uZS52b2x1bWU7XG4gICAgICAvL2xldCdzIHVzZSBleHBvbmVudGlhbCBpbnN0ZWFkIG9mIGxpbmVhciBnYWluLlxuICAgICAgdG9uZS5nYWluLmdhaW4udmFsdWUgPSBmcmFjICogZnJhYztcbiAgICB9XG4gIH1cblxuICB3aGlsZSh0b0RlcXVldWUgPiAwKSB7XG4gICAgLy9hY3RpdmVzIHNob3VsZCBiZSBvcmRlcmVkIGJ5IGR1cmF0aW9uLCBzbyB3ZSBjYW4ganVzdCBzaGlmdCBmcm9tIHRoZSBmcm9udCB0byBkZXF1ZXVlIHRoZW0uXG4gICAgYXVkaW8uYWN0aXZlcy5zaGlmdCgpO1xuICAgIC8vYXVkaW8ucG9vbC5wdXNoKClcbiAgICB0b0RlcXVldWUtLTtcbiAgfVxufVxuXG4vL1RPRE86IGhhbmRsZSBwYW4gdXNpbmcgYSBQYW5uZXJOb2RlXG5mdW5jdGlvbiBhZGRUb25lKG5vdGUsIHBhbiwgdm9sdW1lKSB7XG4gIGlmKGF1ZGlvLmFjdGl2ZXMubGVuZ3RoID4gOCkge1xuICAgIHJldHVybjtcbiAgfVxuICAvL3RvbmUgPSBhdWRpby5wb29sLnBvcCgpXG4gIGxldCB0b25lID0gbnVsbDtcbiAgaWYoIXRvbmUpIHtcbiAgICBjb25zdCBvc2MgPSBhdWRpby5jdHguY3JlYXRlT3NjaWxsYXRvcigpO1xuICAgIG9zYy50eXBlID0gJ3NpbmUnO1xuXG4gICAgY29uc3QgZ2FpbiA9IGF1ZGlvLmN0eC5jcmVhdGVHYWluKCk7XG4gICAgb3NjLmNvbm5lY3QoZ2Fpbik7XG5cbiAgICBnYWluLmNvbm5lY3QoYXVkaW8uY3R4LmRlc3RpbmF0aW9uKTtcbiAgICB0b25lID0ge1xuICAgICAgb3NjOiBvc2MsXG4gICAgICBnYWluOiBnYWluXG4gICAgfTtcbiAgICAvL0hBQ0s6IHN0YXJ0IHRoZSBvc2NpbGxhdG9yIG9uIGluaXRpYWxpemF0aW9uIGFuZCBuZXZlciBzdG9wIGl0LFxuICAgIC8vc2luY2UgaXQgc2VlbXMgdG8gZ2V0IGVycm9uZW91c2x5IEdDJ2Qgb3IgbWVzc2VkIHVwIG90aGVyd2lzZT9cbiAgfVxuXG4gIHRvbmUuZHVyYXRpb24gPSAxMDAwO1xuICB0b25lLmluaXREdXJhdGlvbiA9IHRvbmUuZHVyYXRpb247XG5cbiAgdG9uZS52b2x1bWUgPSB2b2x1bWU7XG4gIHRvbmUuZ2Fpbi5nYWluLnZhbHVlID0gdG9uZS52b2x1bWU7XG5cbiAgdG9uZS5vc2MuZnJlcXVlbmN5LnZhbHVlID0gNDQwICogTWF0aC5wb3coMiwgKG5vdGUgLyAxMikgLSAxKTtcblxuICB0b25lLm9zYy5zdGFydCgwKTtcblxuICBhdWRpby5hY3RpdmVzLnB1c2godG9uZSk7XG59XG5cbmZ1bmN0aW9uIG9uTW91c2VNb3ZlKGV2ZW50KSB7XG4gIGlmKGNob3JkQ2hhbmdlVGltZW91dCA8IDApIHtcbiAgICBjaG9yZEluZGV4ID0gKGNob3JkSW5kZXggKyAxKSAlIGNvbmZpZy5jaG9yZExpc3QubGVuZ3RoO1xuICAgIHNldENob3JkKGNob3JkSW5kZXgpO1xuICB9XG5cbiAgY2hvcmRDaGFuZ2VUaW1lb3V0ID0gY29uZmlnLmNob3JkQ2hhbmdlVGltZW91dDtcbn1cblxuZnVuY3Rpb24gc2V0Q2hvcmQoaW5kZXgpIHtcbiAgY29uc3QgY2hvcmROb3RlcyA9IGNvbmZpZy5jaG9yZExpc3RbaW5kZXhdO1xuXG4gIHNjYWxlID0gW107XG5cbiAgbm90ZXMuZm9yRWFjaCgobm90ZSwgaSkgPT4ge1xuICAgIGlmKGNob3JkTm90ZXMuaW5kZXhPZihub3RlKSAhPT0gLTEpIHtcbiAgICAgIHNjYWxlLnB1c2goaSk7XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gYWRkRG90KCkge1xuICBjb25zdCBkb3QgPSBuZXcgY3JlYXRlanMuUG9pbnQoXG4gICAgTWF0aC5yYW5kb20oKSAqIGNhbnZhcy53aWR0aCxcbiAgICBNYXRoLnJhbmRvbSgpICogY2FudmFzLmhlaWdodFxuICApO1xuXG4gIGRvdC52ZWxvY2l0eSA9IG5ldyBjcmVhdGVqcy5Qb2ludCgwLCAwKTtcbiAgZG90LmNvbnRhY3RUaW1lb3V0ID0gY29uZmlnLmNvbnRhY3RUaW1lb3V0O1xuXG4gIGRvdHMucHVzaChkb3QpO1xufVxuXG5mdW5jdGlvbiB3cmFwVG9TdGFnZShkb3QpIHtcbiAgaWYgKGRvdC54IDwgMCkge1xuICAgIGRvdC54ICs9IGNhbnZhcy53aWR0aDtcbiAgfVxuICBlbHNlIGlmIChkb3QueCA+IGNhbnZhcy53aWR0aCkge1xuICAgIGRvdC54IC09IGNhbnZhcy53aWR0aDtcbiAgfVxuICBpZiAoZG90LnkgPCAwKSB7XG4gICAgZG90LnkgKz0gY2FudmFzLmhlaWdodDtcbiAgfVxuICBlbHNlIGlmIChkb3QueSA+IGNhbnZhcy5oZWlnaHQpIHtcbiAgICBkb3QueSAtPSBjYW52YXMuaGVpZ2h0O1xuICB9XG59XG5cbmZ1bmN0aW9uIGNsYW1wKHZhbCwgbWluLCBtYXgpIHtcbiAgcmV0dXJuIE1hdGgubWF4KG1pbiwgTWF0aC5taW4obWF4LCB2YWwpKTtcbn1cblxuIl19