//verse.js
//2014 - 2015

/*global createjs */

'use strict';

var notes = ['e', 'f', 'f#', 'g', 'g#', 'a', 'a#', 'b', 'c', 'c#', 'd', 'd#', 'e', 'f', 'f#', 'g', 'g#', 'a', 'a#', 'b', 'c', 'c#', 'd', 'd#', 'e', 'f', 'f#', 'g', 'g#', 'a', 'a#', 'b', 'c', 'c#', 'd', 'd#', 'e'];

var config = {
  maxDotFactor: 60 / 500000,
  maxMouseDistance: 100,
  maxContactDistance: 50,
  contactTimeout: 400,
  contactVelocityFactor: 0.5,
  dotSpeedThreshold: 10,
  dotDeceleration: 0.99,
  fadeFactor: 0.05,
  chordChangeTimeout: 5000,
  dotAddRemoveTimeout: 100,
  noteTriggerTimeout: 50,
  chordList: ['e, c, g', 'e, b, g']
};

var audio = {
  actives: [],
  pool: []
};

var maxDotCount = 1;

var dots = [];

var lastMouse = {
  x: 0,
  y: 0
};

var chordChangeTimeout = 0;
var dotAddRemoveTimeout = 0;
var noteTriggerTimeout = 0;
var chordIndex = 0;
var scale = [];

var fadeRect = null;
var canvas = null;
var stage = null;
var drawingCanvas = null;

function init() {
  canvas = document.getElementById('mainCanvas');

  stage = new createjs.Stage(canvas);
  stage.autoClear = false;
  stage.enableDOMEvents(true);

  createjs.Touch.enable(stage);

  createjs.Ticker.timingMode = createjs.Ticker.RAF_SYNCHED;
  createjs.Ticker.setFPS(60);

  canvas.setAttribute('style', 'background-color: #000000');

  drawingCanvas = new createjs.Shape();
  stage.addChild(drawingCanvas);

  fadeRect = new createjs.Shape();
  stage.addChild(fadeRect);

  setChord(chordIndex);

  //audio stuff.
  window.AudioContext = window.AudioContext || window.webkitAudioContext;
  if (!window.AudioContext) {
    console.log('audio api not available!');
    //TODO: do something smart to handle the api not being available.
  } else {
    audio.ctx = new AudioContext();
  }

  window.addEventListener('resize', onResize);
  onResize();
  stage.addEventListener('stagemousemove', onMouseMove);
  createjs.Ticker.addEventListener('tick', onTick);
}

function onResize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  fadeRect.graphics.clear().beginFill('rgba(0,0,0,' + config.fadeFactor + ')').rect(0, 0, canvas.width, canvas.height);

  maxDotCount = Math.round(config.maxDotFactor * canvas.width * canvas.height);
  console.log('maxDotCount: ' + maxDotCount);
}

//TODO: should be okay to not use our delta time everywhere because our ticker
//mode is RAF_SYNCHED, but we should do it anyway.
function onTick(event) {
  tickTones(event.delta);
  chordChangeTimeout -= event.delta;
  dotAddRemoveTimeout -= event.delta;
  noteTriggerTimeout -= event.delta;

  var dMouseX = stage.mouseX - lastMouse.x;
  var dMouseY = stage.mouseY - lastMouse.y;

  if (dotAddRemoveTimeout < 0) {
    dotAddRemoveTimeout = config.dotAddRemoveTimeout;
    if (dots.length < maxDotCount) {
      addDot();
      console.log('adding... ' + dots.length);
    } else if (dots.length > maxDotCount) {
      dots.pop();
      console.log('removing... ' + dots.length);
    }
  }

  var g = drawingCanvas.graphics;

  g.clear().setStrokeStyle(1).beginStroke('#ffffff');

  var wasNotePlayed = false;

  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = dots[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      var dot = _step.value;

      g.moveTo(dot.x, dot.y);
      dot.x += dot.velocity.x;
      dot.y += dot.velocity.y;
      g.lineTo(dot.x, dot.y);

      wrapToStage(dot);

      dot.contactTimeout -= event.delta;

      var _iteratorNormalCompletion2 = true;
      var _didIteratorError2 = false;
      var _iteratorError2 = undefined;

      try {
        for (var _iterator2 = dots[Symbol.iterator](), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
          var otherDot = _step2.value;

          if (otherDot === dot) {
            continue;
          }

          var dx = dot.x - otherDot.x;
          var dy = dot.y - otherDot.y;
          var dist = Math.sqrt(dx * dx + dy * dy);

          if (dist > config.maxContactDistance) {
            continue;
          }

          if (dist > 0) {
            var vf = config.contactVelocityFactor;
            dot.velocity.x += vf * dx / dist;
            dot.velocity.y += vf * dy / dist;
            otherDot.velocity.x -= vf * dx / dist;
            otherDot.velocity.y -= vf * dy / dist;
          }

          if (dot.contactTimeout < 0) {
            dot.contactTimeout = config.contactTimeout;

            g.moveTo(dot.x, dot.y).lineTo(otherDot.x, otherDot.y);

            if (!wasNotePlayed && noteTriggerTimeout < 0) {
              wasNotePlayed = true;
              noteTriggerTimeout = config.noteTriggerTimeout;

              var avgYPos = (dot.y + otherDot.y) / 2;
              var indScale = Math.round(Math.random() * 2) * 2 - 1 + scale.length - 1 - Math.round(scale.length * avgYPos / canvas.height);
              indScale = clamp(indScale, 0, scale.length - 1);

              var avgXPos = (dot.x + otherDot.x) / 2;
              var pan = avgXPos / (canvas.width * 0.5) - 1;

              var avgXVel = (Math.abs(dot.velocity.x) + Math.abs(otherDot.velocity.x)) / 2;
              var avgYVel = (Math.abs(dot.velocity.y) + Math.abs(otherDot.velocity.y)) / 2;

              var avgVelocity = Math.sqrt(avgXVel * avgXVel + avgYVel * avgYVel);
              avgVelocity = clamp(avgVelocity, 0, config.dotSpeedThreshold);

              var volume = 0.2 + 0.8 * (avgVelocity / config.dotSpeedThreshold);

              var note = scale[indScale];

              addTone(note, pan, volume);
            }
          }
        }
      } catch (err) {
        _didIteratorError2 = true;
        _iteratorError2 = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion2 && _iterator2['return']) {
            _iterator2['return']();
          }
        } finally {
          if (_didIteratorError2) {
            throw _iteratorError2;
          }
        }
      }

      //done iterating through other dots.

      var dX = dot.x - stage.mouseX;
      var dY = dot.y - stage.mouseY;

      var distMouse = Math.sqrt(dX * dX + dY * dY);

      if (distMouse < config.maxMouseDistance) {
        dot.velocity.x += 0.001 * (config.maxMouseDistance - distMouse) * dMouseX;
        dot.velocity.y += 0.001 * (config.maxMouseDistance - distMouse) * dMouseY;
      }

      var speed = Math.sqrt(dot.velocity.x * dot.velocity.x + dot.velocity.y * dot.velocity.y);
      if (speed > config.dotSpeedThreshold) {
        dot.velocity.x = config.dotSpeedThreshold * dot.velocity.x / speed;
        dot.velocity.y = config.dotSpeedThreshold * dot.velocity.y / speed;
      }

      dot.velocity.x *= config.dotDeceleration;
      dot.velocity.y *= config.dotDeceleration;
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator['return']) {
        _iterator['return']();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }

  lastMouse.x = stage.mouseX;
  lastMouse.y = stage.mouseY;

  stage.update();
}

function tickTones(delta) {
  var toDequeue = 0;

  var _iteratorNormalCompletion3 = true;
  var _didIteratorError3 = false;
  var _iteratorError3 = undefined;

  try {
    for (var _iterator3 = audio.actives[Symbol.iterator](), _step3; !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
      var tone = _step3.value;

      tone.duration -= delta;

      if (tone.duration < 0) {
        //tone.gain.gain.value = 0
        toDequeue++;
      } else {
        var frac = tone.duration / tone.initDuration * tone.volume;
        //let's use exponential instead of linear gain.
        tone.gain.gain.value = frac * frac;
      }
    }
  } catch (err) {
    _didIteratorError3 = true;
    _iteratorError3 = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion3 && _iterator3['return']) {
        _iterator3['return']();
      }
    } finally {
      if (_didIteratorError3) {
        throw _iteratorError3;
      }
    }
  }

  while (toDequeue > 0) {
    //actives should be ordered by duration, so we can just shift from the front to dequeue them.
    var deq = audio.actives.shift();
    deq.osc.stop(0);
    deq.osc.disconnect();
    deq.gain.disconnect();
    delete deq.osc;
    delete deq.gain;
    //audio.pool.push()
    toDequeue--;
  }
}

//TODO: handle pan using a PannerNode
function addTone(note, pan, volume) {
  if (audio.actives.length > 8) {
    return;
  }
  //tone = audio.pool.pop()
  var tone = null;
  if (!tone) {
    var osc = audio.ctx.createOscillator();
    osc.type = 'sine';

    var gain = audio.ctx.createGain();
    osc.connect(gain);
    gain.connect(audio.ctx.destination);

    tone = {
      osc: osc,
      gain: gain
    };
  }

  tone.duration = 1000;
  tone.initDuration = tone.duration;

  tone.volume = volume;
  tone.gain.gain.value = tone.volume;

  tone.osc.frequency.value = 440 * Math.pow(2, note / 12 - 1);

  tone.osc.start(0);

  audio.actives.push(tone);
}

function onMouseMove(event) {
  if (chordChangeTimeout < 0) {
    chordIndex = (chordIndex + 1) % config.chordList.length;
    setChord(chordIndex);
  }

  chordChangeTimeout = config.chordChangeTimeout;
}

function setChord(index) {
  var chordNotes = config.chordList[index];

  scale = [];

  notes.forEach(function (note, i) {
    if (chordNotes.indexOf(note) !== -1) {
      scale.push(i);
    }
  });
}

function addDot() {
  var dot = new createjs.Point(Math.random() * canvas.width, Math.random() * canvas.height);

  dot.velocity = new createjs.Point(0, 0);
  dot.contactTimeout = config.contactTimeout;

  dots.push(dot);
}

function wrapToStage(dot) {
  if (dot.x < 0) {
    dot.x += canvas.width;
  } else if (dot.x > canvas.width) {
    dot.x -= canvas.width;
  }
  if (dot.y < 0) {
    dot.y += canvas.height;
  } else if (dot.y > canvas.height) {
    dot.y -= canvas.height;
  }
}

function clamp(val, min, max) {
  return Math.max(min, Math.min(max, val));
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZlcnNlMi5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBS0EsSUFBTSxLQUFLLEdBQUcsQ0FDWixHQUFHLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUN6QixHQUFHLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUN6QixHQUFHLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUN6QixHQUFHLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUN6QixHQUFHLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUN6QixHQUFHLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUN6QixJQUFJLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUN6QixJQUFJLEVBQUUsR0FBRyxDQUNWLENBQUM7O0FBRUYsSUFBTSxNQUFNLEdBQUc7QUFDYixjQUFZLEVBQUUsRUFBRSxHQUFHLE1BQU07QUFDekIsa0JBQWdCLEVBQUUsR0FBRztBQUNyQixvQkFBa0IsRUFBRSxFQUFFO0FBQ3RCLGdCQUFjLEVBQUUsR0FBRztBQUNuQix1QkFBcUIsRUFBRSxHQUFHO0FBQzFCLG1CQUFpQixFQUFFLEVBQUU7QUFDckIsaUJBQWUsRUFBRSxJQUFJO0FBQ3JCLFlBQVUsRUFBRSxJQUFJO0FBQ2hCLG9CQUFrQixFQUFFLElBQUk7QUFDeEIscUJBQW1CLEVBQUUsR0FBRztBQUN4QixvQkFBa0IsRUFBRSxFQUFFO0FBQ3RCLFdBQVMsRUFBRSxDQUFDLFNBQVMsRUFBRSxTQUFTLENBQUM7Q0FDbEMsQ0FBQzs7QUFFRixJQUFJLEtBQUssR0FBRztBQUNWLFNBQU8sRUFBRSxFQUFFO0FBQ1gsTUFBSSxFQUFFLEVBQUU7Q0FDVCxDQUFDOztBQUVGLElBQUksV0FBVyxHQUFHLENBQUMsQ0FBQzs7QUFFcEIsSUFBSSxJQUFJLEdBQUcsRUFBRSxDQUFDOztBQUVkLElBQUksU0FBUyxHQUFHO0FBQ2QsR0FBQyxFQUFFLENBQUM7QUFDSixHQUFDLEVBQUUsQ0FBQztDQUNMLENBQUM7O0FBRUYsSUFBSSxrQkFBa0IsR0FBRyxDQUFDLENBQUM7QUFDM0IsSUFBSSxtQkFBbUIsR0FBRyxDQUFDLENBQUM7QUFDNUIsSUFBSSxrQkFBa0IsR0FBRyxDQUFDLENBQUM7QUFDM0IsSUFBSSxVQUFVLEdBQUcsQ0FBQyxDQUFDO0FBQ25CLElBQUksS0FBSyxHQUFHLEVBQUUsQ0FBQzs7QUFFZixJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUM7QUFDcEIsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDO0FBQ2xCLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQztBQUNqQixJQUFJLGFBQWEsR0FBRyxJQUFJLENBQUM7O0FBRXpCLFNBQVMsSUFBSSxHQUFHO0FBQ2QsUUFBTSxHQUFHLFFBQVEsQ0FBQyxjQUFjLENBQUMsWUFBWSxDQUFDLENBQUM7O0FBRS9DLE9BQUssR0FBRyxJQUFJLFFBQVEsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDbkMsT0FBSyxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7QUFDeEIsT0FBSyxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQzs7QUFFNUIsVUFBUSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7O0FBRTdCLFVBQVEsQ0FBQyxNQUFNLENBQUMsVUFBVSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDO0FBQ3pELFVBQVEsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDOztBQUUzQixRQUFNLENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRSwyQkFBMkIsQ0FBQyxDQUFDOztBQUUxRCxlQUFhLEdBQUcsSUFBSSxRQUFRLENBQUMsS0FBSyxFQUFFLENBQUM7QUFDckMsT0FBSyxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsQ0FBQzs7QUFFOUIsVUFBUSxHQUFHLElBQUksUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFDO0FBQ2hDLE9BQUssQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUM7O0FBRXpCLFVBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQzs7O0FBR3JCLFFBQU0sQ0FBQyxZQUFZLEdBQUcsTUFBTSxDQUFDLFlBQVksSUFBSSxNQUFNLENBQUMsa0JBQWtCLENBQUM7QUFDdkUsTUFBRyxDQUFDLE1BQU0sQ0FBQyxZQUFZLEVBQUU7QUFDdkIsV0FBTyxDQUFDLEdBQUcsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDOztHQUV6QyxNQUNJO0FBQ0gsU0FBSyxDQUFDLEdBQUcsR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO0dBQ2hDOztBQUVELFFBQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsUUFBUSxDQUFDLENBQUM7QUFDNUMsVUFBUSxFQUFFLENBQUM7QUFDWCxPQUFLLENBQUMsZ0JBQWdCLENBQUMsZ0JBQWdCLEVBQUUsV0FBVyxDQUFDLENBQUM7QUFDdEQsVUFBUSxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7Q0FDbEQ7O0FBRUQsU0FBUyxRQUFRLEdBQUc7QUFDbEIsUUFBTSxDQUFDLEtBQUssR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDO0FBQ2pDLFFBQU0sQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQztBQUNuQyxVQUFRLENBQUMsUUFBUSxDQUNkLEtBQUssRUFBRSxDQUNQLFNBQVMsaUJBQWdCLE1BQU0sQ0FBQyxVQUFVLE9BQUssQ0FDL0MsSUFBSSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsTUFBTSxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7O0FBRTNDLGFBQVcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxZQUFZLEdBQUcsTUFBTSxDQUFDLEtBQUssR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDN0UsU0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLEdBQUcsV0FBVyxDQUFDLENBQUM7Q0FDNUM7Ozs7QUFJRCxTQUFTLE1BQU0sQ0FBQyxLQUFLLEVBQUU7QUFDckIsV0FBUyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUN2QixvQkFBa0IsSUFBSSxLQUFLLENBQUMsS0FBSyxDQUFDO0FBQ2xDLHFCQUFtQixJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUM7QUFDbkMsb0JBQWtCLElBQUksS0FBSyxDQUFDLEtBQUssQ0FBQzs7QUFFbEMsTUFBTSxPQUFPLEdBQUcsS0FBSyxDQUFDLE1BQU0sR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDO0FBQzNDLE1BQU0sT0FBTyxHQUFHLEtBQUssQ0FBQyxNQUFNLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQzs7QUFFM0MsTUFBRyxtQkFBbUIsR0FBRyxDQUFDLEVBQUU7QUFDMUIsdUJBQW1CLEdBQUcsTUFBTSxDQUFDLG1CQUFtQixDQUFDO0FBQ2pELFFBQUcsSUFBSSxDQUFDLE1BQU0sR0FBRyxXQUFXLEVBQUM7QUFDM0IsWUFBTSxFQUFFLENBQUM7QUFDVCxhQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7S0FDekMsTUFDSSxJQUFHLElBQUksQ0FBQyxNQUFNLEdBQUcsV0FBVyxFQUFDO0FBQ2hDLFVBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUNYLGFBQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztLQUMzQztHQUNGOztBQUVELE1BQU0sQ0FBQyxHQUFHLGFBQWEsQ0FBQyxRQUFRLENBQUM7O0FBRWpDLEdBQUMsQ0FDRSxLQUFLLEVBQUUsQ0FDUCxjQUFjLENBQUMsQ0FBQyxDQUFDLENBQ2pCLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQzs7QUFHMUIsTUFBSSxhQUFhLEdBQUcsS0FBSyxDQUFDOzs7Ozs7O0FBRTFCLHlCQUFlLElBQUksOEhBQUU7VUFBYixHQUFHOztBQUNULE9BQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDdkIsU0FBRyxDQUFDLENBQUMsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztBQUN4QixTQUFHLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO0FBQ3hCLE9BQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7O0FBRXZCLGlCQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7O0FBRWpCLFNBQUcsQ0FBQyxjQUFjLElBQUksS0FBSyxDQUFDLEtBQUssQ0FBQzs7Ozs7OztBQUVsQyw4QkFBb0IsSUFBSSxtSUFBRTtjQUFsQixRQUFROztBQUNkLGNBQUcsUUFBUSxLQUFLLEdBQUcsRUFBRTtBQUNuQixxQkFBUztXQUNWOztBQUVELGNBQU0sRUFBRSxHQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQztBQUM5QixjQUFNLEVBQUUsR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUM7QUFDOUIsY0FBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQzs7QUFFMUMsY0FBRyxJQUFJLEdBQUcsTUFBTSxDQUFDLGtCQUFrQixFQUFFO0FBQ25DLHFCQUFTO1dBQ1Y7O0FBRUQsY0FBRyxJQUFJLEdBQUcsQ0FBQyxFQUFFO0FBQ1gsZ0JBQU0sRUFBRSxHQUFHLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQztBQUN4QyxlQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQztBQUNqQyxlQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQztBQUNqQyxvQkFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUM7QUFDdEMsb0JBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDO1dBQ3ZDOztBQUVELGNBQUcsR0FBRyxDQUFDLGNBQWMsR0FBRyxDQUFDLEVBQUU7QUFDekIsZUFBRyxDQUFDLGNBQWMsR0FBRyxNQUFNLENBQUMsY0FBYyxDQUFDOztBQUUzQyxhQUFDLENBQ0UsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUNwQixNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7O0FBRWxDLGdCQUFHLENBQUMsYUFBYSxJQUFJLGtCQUFrQixHQUFHLENBQUMsRUFBRTtBQUMzQywyQkFBYSxHQUFHLElBQUksQ0FBQztBQUNyQixnQ0FBa0IsR0FBRyxNQUFNLENBQUMsa0JBQWtCLENBQUM7O0FBRS9DLGtCQUFNLE9BQU8sR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQSxHQUFJLENBQUMsQ0FBQztBQUN6QyxrQkFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFFLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsT0FBTyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUM5SCxzQkFBUSxHQUFHLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQyxFQUFFLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7O0FBRWhELGtCQUFNLE9BQU8sR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQSxHQUFJLENBQUMsQ0FBQztBQUN6QyxrQkFBTSxHQUFHLEdBQUcsT0FBTyxJQUFJLE1BQU0sQ0FBQyxLQUFLLEdBQUcsR0FBRyxDQUFBLEFBQUMsR0FBRyxDQUFDLENBQUM7O0FBRS9DLGtCQUFNLE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUEsR0FBSSxDQUFDLENBQUM7QUFDL0Usa0JBQU0sT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQSxHQUFJLENBQUMsQ0FBQzs7QUFFL0Usa0JBQUksV0FBVyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sR0FBRyxPQUFPLEdBQUcsT0FBTyxDQUFDLENBQUM7QUFDbkUseUJBQVcsR0FBRyxLQUFLLENBQUMsV0FBVyxFQUFFLENBQUMsRUFBRSxNQUFNLENBQUMsaUJBQWlCLENBQUMsQ0FBQzs7QUFFOUQsa0JBQU0sTUFBTSxHQUFHLEdBQUcsR0FBRyxHQUFHLElBQUksV0FBVyxHQUFHLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQSxBQUFDLENBQUM7O0FBRXBFLGtCQUFNLElBQUksR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7O0FBRTdCLHFCQUFPLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxNQUFNLENBQUMsQ0FBQzthQUM1QjtXQUNGO1NBQ0Y7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVELFVBQU0sRUFBRSxHQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQztBQUNoQyxVQUFNLEVBQUUsR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUM7O0FBRWhDLFVBQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7O0FBRS9DLFVBQUcsU0FBUyxHQUFHLE1BQU0sQ0FBQyxnQkFBZ0IsRUFBRTtBQUN0QyxXQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxLQUFLLElBQUksTUFBTSxDQUFDLGdCQUFnQixHQUFHLFNBQVMsQ0FBQSxBQUFDLEdBQUcsT0FBTyxDQUFDO0FBQzFFLFdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLEtBQUssSUFBSSxNQUFNLENBQUMsZ0JBQWdCLEdBQUcsU0FBUyxDQUFBLEFBQUMsR0FBRyxPQUFPLENBQUM7T0FDM0U7O0FBRUQsVUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzNGLFVBQUcsS0FBSyxHQUFHLE1BQU0sQ0FBQyxpQkFBaUIsRUFBRTtBQUNuQyxXQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsaUJBQWlCLEdBQUcsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDO0FBQ25FLFdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxpQkFBaUIsR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUM7T0FDcEU7O0FBRUQsU0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksTUFBTSxDQUFDLGVBQWUsQ0FBQztBQUN6QyxTQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxNQUFNLENBQUMsZUFBZSxDQUFDO0tBRTFDOzs7Ozs7Ozs7Ozs7Ozs7O0FBRUQsV0FBUyxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDO0FBQzNCLFdBQVMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQzs7QUFFM0IsT0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDO0NBQ2hCOztBQUdELFNBQVMsU0FBUyxDQUFDLEtBQUssRUFBRTtBQUN4QixNQUFJLFNBQVMsR0FBRyxDQUFDLENBQUM7Ozs7Ozs7QUFFbEIsMEJBQWdCLEtBQUssQ0FBQyxPQUFPLG1JQUFFO1VBQXZCLElBQUk7O0FBQ1YsVUFBSSxDQUFDLFFBQVEsSUFBSSxLQUFLLENBQUM7O0FBRXZCLFVBQUcsSUFBSSxDQUFDLFFBQVEsR0FBRyxDQUFDLEVBQUU7O0FBRXBCLGlCQUFTLEVBQUUsQ0FBQztPQUNiLE1BQ0k7QUFDSCxZQUFNLElBQUksR0FBRyxBQUFDLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFlBQVksR0FBSSxJQUFJLENBQUMsTUFBTSxDQUFDOztBQUUvRCxZQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQztPQUNwQztLQUNGOzs7Ozs7Ozs7Ozs7Ozs7O0FBRUQsU0FBTSxTQUFTLEdBQUcsQ0FBQyxFQUFFOztBQUVuQixRQUFNLEdBQUcsR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO0FBQ2xDLE9BQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2hCLE9BQUcsQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLENBQUM7QUFDckIsT0FBRyxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztBQUN0QixXQUFPLEdBQUcsQ0FBQyxHQUFHLENBQUM7QUFDZixXQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUM7O0FBRWhCLGFBQVMsRUFBRSxDQUFDO0dBQ2I7Q0FDRjs7O0FBR0QsU0FBUyxPQUFPLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUU7QUFDbEMsTUFBRyxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7QUFDM0IsV0FBTztHQUNSOztBQUVELE1BQUksSUFBSSxHQUFHLElBQUksQ0FBQztBQUNoQixNQUFHLENBQUMsSUFBSSxFQUFFO0FBQ1IsUUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO0FBQ3pDLE9BQUcsQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDOztBQUVsQixRQUFNLElBQUksR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxDQUFDO0FBQ3BDLE9BQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDbEIsUUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDOztBQUVwQyxRQUFJLEdBQUc7QUFDTCxTQUFHLEVBQUUsR0FBRztBQUNSLFVBQUksRUFBRSxJQUFJO0tBQ1gsQ0FBQztHQUNIOztBQUVELE1BQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO0FBQ3JCLE1BQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQzs7QUFFbEMsTUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7QUFDckIsTUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7O0FBRW5DLE1BQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLEtBQUssR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQUFBQyxJQUFJLEdBQUcsRUFBRSxHQUFJLENBQUMsQ0FBQyxDQUFDOztBQUU5RCxNQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQzs7QUFFbEIsT0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Q0FDMUI7O0FBRUQsU0FBUyxXQUFXLENBQUMsS0FBSyxFQUFFO0FBQzFCLE1BQUcsa0JBQWtCLEdBQUcsQ0FBQyxFQUFFO0FBQ3pCLGNBQVUsR0FBRyxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUEsR0FBSSxNQUFNLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQztBQUN4RCxZQUFRLENBQUMsVUFBVSxDQUFDLENBQUM7R0FDdEI7O0FBRUQsb0JBQWtCLEdBQUcsTUFBTSxDQUFDLGtCQUFrQixDQUFDO0NBQ2hEOztBQUVELFNBQVMsUUFBUSxDQUFDLEtBQUssRUFBRTtBQUN2QixNQUFNLFVBQVUsR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDOztBQUUzQyxPQUFLLEdBQUcsRUFBRSxDQUFDOztBQUVYLE9BQUssQ0FBQyxPQUFPLENBQUMsVUFBQyxJQUFJLEVBQUUsQ0FBQyxFQUFLO0FBQ3pCLFFBQUcsVUFBVSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRTtBQUNsQyxXQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ2Y7R0FDRixDQUFDLENBQUM7Q0FDSjs7QUFFRCxTQUFTLE1BQU0sR0FBRztBQUNoQixNQUFNLEdBQUcsR0FBRyxJQUFJLFFBQVEsQ0FBQyxLQUFLLENBQzVCLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxNQUFNLENBQUMsS0FBSyxFQUM1QixJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FDOUIsQ0FBQzs7QUFFRixLQUFHLENBQUMsUUFBUSxHQUFHLElBQUksUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFDeEMsS0FBRyxDQUFDLGNBQWMsR0FBRyxNQUFNLENBQUMsY0FBYyxDQUFDOztBQUUzQyxNQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0NBQ2hCOztBQUVELFNBQVMsV0FBVyxDQUFDLEdBQUcsRUFBRTtBQUN4QixNQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFO0FBQ2IsT0FBRyxDQUFDLENBQUMsSUFBSSxNQUFNLENBQUMsS0FBSyxDQUFDO0dBQ3ZCLE1BQ0ksSUFBSSxHQUFHLENBQUMsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxLQUFLLEVBQUU7QUFDN0IsT0FBRyxDQUFDLENBQUMsSUFBSSxNQUFNLENBQUMsS0FBSyxDQUFDO0dBQ3ZCO0FBQ0QsTUFBSSxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRTtBQUNiLE9BQUcsQ0FBQyxDQUFDLElBQUksTUFBTSxDQUFDLE1BQU0sQ0FBQztHQUN4QixNQUNJLElBQUksR0FBRyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsTUFBTSxFQUFFO0FBQzlCLE9BQUcsQ0FBQyxDQUFDLElBQUksTUFBTSxDQUFDLE1BQU0sQ0FBQztHQUN4QjtDQUNGOztBQUVELFNBQVMsS0FBSyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFO0FBQzVCLFNBQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztDQUMxQyIsImZpbGUiOiJ2ZXJzZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vdmVyc2UuanNcbi8vMjAxNCAtIDIwMTVcblxuLypnbG9iYWwgY3JlYXRlanMgKi9cblxuY29uc3Qgbm90ZXMgPSBbXG4gICdlJywgJ2YnLCAnZiMnLCAnZycsICdnIycsXG4gICdhJywgJ2EjJywgJ2InLCAnYycsICdjIycsXG4gICdkJywgJ2QjJywgJ2UnLCAnZicsICdmIycsXG4gICdnJywgJ2cjJywgJ2EnLCAnYSMnLCAnYicsXG4gICdjJywgJ2MjJywgJ2QnLCAnZCMnLCAnZScsXG4gICdmJywgJ2YjJywgJ2cnLCAnZyMnLCAnYScsXG4gICdhIycsICdiJywgJ2MnLCAnYyMnLCAnZCcsXG4gICdkIycsICdlJ1xuXTtcblxuY29uc3QgY29uZmlnID0ge1xuICBtYXhEb3RGYWN0b3I6IDYwIC8gNTAwMDAwLFxuICBtYXhNb3VzZURpc3RhbmNlOiAxMDAsXG4gIG1heENvbnRhY3REaXN0YW5jZTogNTAsXG4gIGNvbnRhY3RUaW1lb3V0OiA0MDAsXG4gIGNvbnRhY3RWZWxvY2l0eUZhY3RvcjogMC41LFxuICBkb3RTcGVlZFRocmVzaG9sZDogMTAsXG4gIGRvdERlY2VsZXJhdGlvbjogMC45OSxcbiAgZmFkZUZhY3RvcjogMC4wNSxcbiAgY2hvcmRDaGFuZ2VUaW1lb3V0OiA1MDAwLFxuICBkb3RBZGRSZW1vdmVUaW1lb3V0OiAxMDAsXG4gIG5vdGVUcmlnZ2VyVGltZW91dDogNTAsXG4gIGNob3JkTGlzdDogWydlLCBjLCBnJywgJ2UsIGIsIGcnXVxufTtcblxubGV0IGF1ZGlvID0ge1xuICBhY3RpdmVzOiBbXSxcbiAgcG9vbDogW11cbn07XG5cbmxldCBtYXhEb3RDb3VudCA9IDE7XG5cbmxldCBkb3RzID0gW107XG5cbmxldCBsYXN0TW91c2UgPSB7XG4gIHg6IDAsXG4gIHk6IDBcbn07XG5cbmxldCBjaG9yZENoYW5nZVRpbWVvdXQgPSAwO1xubGV0IGRvdEFkZFJlbW92ZVRpbWVvdXQgPSAwO1xubGV0IG5vdGVUcmlnZ2VyVGltZW91dCA9IDA7XG5sZXQgY2hvcmRJbmRleCA9IDA7XG5sZXQgc2NhbGUgPSBbXTtcblxubGV0IGZhZGVSZWN0ID0gbnVsbDtcbmxldCBjYW52YXMgPSBudWxsO1xubGV0IHN0YWdlID0gbnVsbDtcbmxldCBkcmF3aW5nQ2FudmFzID0gbnVsbDtcblxuZnVuY3Rpb24gaW5pdCgpIHtcbiAgY2FudmFzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW5DYW52YXMnKTtcblxuICBzdGFnZSA9IG5ldyBjcmVhdGVqcy5TdGFnZShjYW52YXMpO1xuICBzdGFnZS5hdXRvQ2xlYXIgPSBmYWxzZTtcbiAgc3RhZ2UuZW5hYmxlRE9NRXZlbnRzKHRydWUpO1xuXG4gIGNyZWF0ZWpzLlRvdWNoLmVuYWJsZShzdGFnZSk7XG5cbiAgY3JlYXRlanMuVGlja2VyLnRpbWluZ01vZGUgPSBjcmVhdGVqcy5UaWNrZXIuUkFGX1NZTkNIRUQ7XG4gIGNyZWF0ZWpzLlRpY2tlci5zZXRGUFMoNjApO1xuXG4gIGNhbnZhcy5zZXRBdHRyaWJ1dGUoJ3N0eWxlJywgJ2JhY2tncm91bmQtY29sb3I6ICMwMDAwMDAnKTtcblxuICBkcmF3aW5nQ2FudmFzID0gbmV3IGNyZWF0ZWpzLlNoYXBlKCk7XG4gIHN0YWdlLmFkZENoaWxkKGRyYXdpbmdDYW52YXMpO1xuXG4gIGZhZGVSZWN0ID0gbmV3IGNyZWF0ZWpzLlNoYXBlKCk7XG4gIHN0YWdlLmFkZENoaWxkKGZhZGVSZWN0KTtcblxuICBzZXRDaG9yZChjaG9yZEluZGV4KTtcblxuICAvL2F1ZGlvIHN0dWZmLlxuICB3aW5kb3cuQXVkaW9Db250ZXh0ID0gd2luZG93LkF1ZGlvQ29udGV4dCB8fCB3aW5kb3cud2Via2l0QXVkaW9Db250ZXh0O1xuICBpZighd2luZG93LkF1ZGlvQ29udGV4dCkge1xuICAgIGNvbnNvbGUubG9nKCdhdWRpbyBhcGkgbm90IGF2YWlsYWJsZSEnKTtcbiAgICAvL1RPRE86IGRvIHNvbWV0aGluZyBzbWFydCB0byBoYW5kbGUgdGhlIGFwaSBub3QgYmVpbmcgYXZhaWxhYmxlLlxuICB9XG4gIGVsc2Uge1xuICAgIGF1ZGlvLmN0eCA9IG5ldyBBdWRpb0NvbnRleHQoKTtcbiAgfVxuXG4gIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCBvblJlc2l6ZSk7XG4gIG9uUmVzaXplKCk7XG4gIHN0YWdlLmFkZEV2ZW50TGlzdGVuZXIoJ3N0YWdlbW91c2Vtb3ZlJywgb25Nb3VzZU1vdmUpO1xuICBjcmVhdGVqcy5UaWNrZXIuYWRkRXZlbnRMaXN0ZW5lcigndGljaycsIG9uVGljayk7XG59XG5cbmZ1bmN0aW9uIG9uUmVzaXplKCkge1xuICBjYW52YXMud2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aDtcbiAgY2FudmFzLmhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodDtcbiAgZmFkZVJlY3QuZ3JhcGhpY3NcbiAgICAuY2xlYXIoKVxuICAgIC5iZWdpbkZpbGwoYHJnYmEoMCwwLDAsJHsgY29uZmlnLmZhZGVGYWN0b3IgfSlgKVxuICAgIC5yZWN0KDAsIDAsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7XG5cbiAgbWF4RG90Q291bnQgPSBNYXRoLnJvdW5kKGNvbmZpZy5tYXhEb3RGYWN0b3IgKiBjYW52YXMud2lkdGggKiBjYW52YXMuaGVpZ2h0KTtcbiAgY29uc29sZS5sb2coJ21heERvdENvdW50OiAnICsgbWF4RG90Q291bnQpO1xufVxuXG4vL1RPRE86IHNob3VsZCBiZSBva2F5IHRvIG5vdCB1c2Ugb3VyIGRlbHRhIHRpbWUgZXZlcnl3aGVyZSBiZWNhdXNlIG91ciB0aWNrZXJcbi8vbW9kZSBpcyBSQUZfU1lOQ0hFRCwgYnV0IHdlIHNob3VsZCBkbyBpdCBhbnl3YXkuXG5mdW5jdGlvbiBvblRpY2soZXZlbnQpIHtcbiAgdGlja1RvbmVzKGV2ZW50LmRlbHRhKTtcbiAgY2hvcmRDaGFuZ2VUaW1lb3V0IC09IGV2ZW50LmRlbHRhO1xuICBkb3RBZGRSZW1vdmVUaW1lb3V0IC09IGV2ZW50LmRlbHRhO1xuICBub3RlVHJpZ2dlclRpbWVvdXQgLT0gZXZlbnQuZGVsdGE7XG5cbiAgY29uc3QgZE1vdXNlWCA9IHN0YWdlLm1vdXNlWCAtIGxhc3RNb3VzZS54O1xuICBjb25zdCBkTW91c2VZID0gc3RhZ2UubW91c2VZIC0gbGFzdE1vdXNlLnk7XG5cbiAgaWYoZG90QWRkUmVtb3ZlVGltZW91dCA8IDApIHtcbiAgICBkb3RBZGRSZW1vdmVUaW1lb3V0ID0gY29uZmlnLmRvdEFkZFJlbW92ZVRpbWVvdXQ7XG4gICAgaWYoZG90cy5sZW5ndGggPCBtYXhEb3RDb3VudCl7XG4gICAgICBhZGREb3QoKTtcbiAgICAgIGNvbnNvbGUubG9nKCdhZGRpbmcuLi4gJyArIGRvdHMubGVuZ3RoKTtcbiAgICB9XG4gICAgZWxzZSBpZihkb3RzLmxlbmd0aCA+IG1heERvdENvdW50KXtcbiAgICAgIGRvdHMucG9wKCk7XG4gICAgICBjb25zb2xlLmxvZygncmVtb3ZpbmcuLi4gJyArIGRvdHMubGVuZ3RoKTtcbiAgICB9XG4gIH1cblxuICBjb25zdCBnID0gZHJhd2luZ0NhbnZhcy5ncmFwaGljcztcblxuICBnXG4gICAgLmNsZWFyKClcbiAgICAuc2V0U3Ryb2tlU3R5bGUoMSlcbiAgICAuYmVnaW5TdHJva2UoJyNmZmZmZmYnKTtcblxuXG4gIGxldCB3YXNOb3RlUGxheWVkID0gZmFsc2U7XG5cbiAgZm9yKGxldCBkb3Qgb2YgZG90cykge1xuICAgIGcubW92ZVRvKGRvdC54LCBkb3QueSk7XG4gICAgZG90LnggKz0gZG90LnZlbG9jaXR5Lng7XG4gICAgZG90LnkgKz0gZG90LnZlbG9jaXR5Lnk7XG4gICAgZy5saW5lVG8oZG90LngsIGRvdC55KTtcblxuICAgIHdyYXBUb1N0YWdlKGRvdCk7XG5cbiAgICBkb3QuY29udGFjdFRpbWVvdXQgLT0gZXZlbnQuZGVsdGE7XG5cbiAgICBmb3IobGV0IG90aGVyRG90IG9mIGRvdHMpIHtcbiAgICAgIGlmKG90aGVyRG90ID09PSBkb3QpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGR4ID0gZG90LnggLSBvdGhlckRvdC54O1xuICAgICAgY29uc3QgZHkgPSBkb3QueSAtIG90aGVyRG90Lnk7XG4gICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGR4ICogZHggKyBkeSAqIGR5KTtcblxuICAgICAgaWYoZGlzdCA+IGNvbmZpZy5tYXhDb250YWN0RGlzdGFuY2UpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGlmKGRpc3QgPiAwKSB7XG4gICAgICAgIGNvbnN0IHZmID0gY29uZmlnLmNvbnRhY3RWZWxvY2l0eUZhY3RvcjtcbiAgICAgICAgZG90LnZlbG9jaXR5LnggKz0gdmYgKiBkeCAvIGRpc3Q7XG4gICAgICAgIGRvdC52ZWxvY2l0eS55ICs9IHZmICogZHkgLyBkaXN0O1xuICAgICAgICBvdGhlckRvdC52ZWxvY2l0eS54IC09IHZmICogZHggLyBkaXN0O1xuICAgICAgICBvdGhlckRvdC52ZWxvY2l0eS55IC09IHZmICogZHkgLyBkaXN0O1xuICAgICAgfVxuXG4gICAgICBpZihkb3QuY29udGFjdFRpbWVvdXQgPCAwKSB7XG4gICAgICAgIGRvdC5jb250YWN0VGltZW91dCA9IGNvbmZpZy5jb250YWN0VGltZW91dDtcblxuICAgICAgICBnXG4gICAgICAgICAgLm1vdmVUbyhkb3QueCwgZG90LnkpXG4gICAgICAgICAgLmxpbmVUbyhvdGhlckRvdC54LCBvdGhlckRvdC55KTtcblxuICAgICAgICBpZighd2FzTm90ZVBsYXllZCAmJiBub3RlVHJpZ2dlclRpbWVvdXQgPCAwKSB7XG4gICAgICAgICAgd2FzTm90ZVBsYXllZCA9IHRydWU7XG4gICAgICAgICAgbm90ZVRyaWdnZXJUaW1lb3V0ID0gY29uZmlnLm5vdGVUcmlnZ2VyVGltZW91dDtcblxuICAgICAgICAgIGNvbnN0IGF2Z1lQb3MgPSAoZG90LnkgKyBvdGhlckRvdC55KSAvIDI7XG4gICAgICAgICAgbGV0IGluZFNjYWxlID0gTWF0aC5yb3VuZChNYXRoLnJhbmRvbSgpICogMiApICogMiAtIDEgKyBzY2FsZS5sZW5ndGggLSAxIC0gTWF0aC5yb3VuZChzY2FsZS5sZW5ndGggKiBhdmdZUG9zIC8gY2FudmFzLmhlaWdodCk7XG4gICAgICAgICAgaW5kU2NhbGUgPSBjbGFtcChpbmRTY2FsZSwgMCwgc2NhbGUubGVuZ3RoIC0gMSk7XG5cbiAgICAgICAgICBjb25zdCBhdmdYUG9zID0gKGRvdC54ICsgb3RoZXJEb3QueCkgLyAyO1xuICAgICAgICAgIGNvbnN0IHBhbiA9IGF2Z1hQb3MgLyAoY2FudmFzLndpZHRoICogMC41KSAtIDE7XG5cbiAgICAgICAgICBjb25zdCBhdmdYVmVsID0gKE1hdGguYWJzKGRvdC52ZWxvY2l0eS54KSArIE1hdGguYWJzKG90aGVyRG90LnZlbG9jaXR5LngpKSAvIDI7XG4gICAgICAgICAgY29uc3QgYXZnWVZlbCA9IChNYXRoLmFicyhkb3QudmVsb2NpdHkueSkgKyBNYXRoLmFicyhvdGhlckRvdC52ZWxvY2l0eS55KSkgLyAyO1xuXG4gICAgICAgICAgbGV0IGF2Z1ZlbG9jaXR5ID0gTWF0aC5zcXJ0KGF2Z1hWZWwgKiBhdmdYVmVsICsgYXZnWVZlbCAqIGF2Z1lWZWwpO1xuICAgICAgICAgIGF2Z1ZlbG9jaXR5ID0gY2xhbXAoYXZnVmVsb2NpdHksIDAsIGNvbmZpZy5kb3RTcGVlZFRocmVzaG9sZCk7XG5cbiAgICAgICAgICBjb25zdCB2b2x1bWUgPSAwLjIgKyAwLjggKiAoYXZnVmVsb2NpdHkgLyBjb25maWcuZG90U3BlZWRUaHJlc2hvbGQpO1xuXG4gICAgICAgICAgY29uc3Qgbm90ZSA9IHNjYWxlW2luZFNjYWxlXTtcblxuICAgICAgICAgIGFkZFRvbmUobm90ZSwgcGFuLCB2b2x1bWUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSAvL2RvbmUgaXRlcmF0aW5nIHRocm91Z2ggb3RoZXIgZG90cy5cblxuICAgIGNvbnN0IGRYID0gZG90LnggLSBzdGFnZS5tb3VzZVg7XG4gICAgY29uc3QgZFkgPSBkb3QueSAtIHN0YWdlLm1vdXNlWTtcblxuICAgIGNvbnN0IGRpc3RNb3VzZSA9IE1hdGguc3FydChkWCAqIGRYICsgZFkgKiBkWSk7XG5cbiAgICBpZihkaXN0TW91c2UgPCBjb25maWcubWF4TW91c2VEaXN0YW5jZSkge1xuICAgICAgZG90LnZlbG9jaXR5LnggKz0gMC4wMDEgKiAoY29uZmlnLm1heE1vdXNlRGlzdGFuY2UgLSBkaXN0TW91c2UpICogZE1vdXNlWDtcbiAgICAgIGRvdC52ZWxvY2l0eS55ICs9IDAuMDAxICogKGNvbmZpZy5tYXhNb3VzZURpc3RhbmNlIC0gZGlzdE1vdXNlKSAqIGRNb3VzZVk7XG4gICAgfVxuXG4gICAgY29uc3Qgc3BlZWQgPSBNYXRoLnNxcnQoZG90LnZlbG9jaXR5LnggKiBkb3QudmVsb2NpdHkueCArIGRvdC52ZWxvY2l0eS55ICogZG90LnZlbG9jaXR5LnkpO1xuICAgIGlmKHNwZWVkID4gY29uZmlnLmRvdFNwZWVkVGhyZXNob2xkKSB7XG4gICAgICBkb3QudmVsb2NpdHkueCA9IGNvbmZpZy5kb3RTcGVlZFRocmVzaG9sZCAqIGRvdC52ZWxvY2l0eS54IC8gc3BlZWQ7XG4gICAgICBkb3QudmVsb2NpdHkueSA9IGNvbmZpZy5kb3RTcGVlZFRocmVzaG9sZCAqIGRvdC52ZWxvY2l0eS55IC8gc3BlZWQ7XG4gICAgfVxuXG4gICAgZG90LnZlbG9jaXR5LnggKj0gY29uZmlnLmRvdERlY2VsZXJhdGlvbjtcbiAgICBkb3QudmVsb2NpdHkueSAqPSBjb25maWcuZG90RGVjZWxlcmF0aW9uO1xuXG4gIH1cblxuICBsYXN0TW91c2UueCA9IHN0YWdlLm1vdXNlWDtcbiAgbGFzdE1vdXNlLnkgPSBzdGFnZS5tb3VzZVk7XG5cbiAgc3RhZ2UudXBkYXRlKCk7XG59XG5cblxuZnVuY3Rpb24gdGlja1RvbmVzKGRlbHRhKSB7XG4gIGxldCB0b0RlcXVldWUgPSAwO1xuXG4gIGZvcihsZXQgdG9uZSBvZiBhdWRpby5hY3RpdmVzKSB7XG4gICAgdG9uZS5kdXJhdGlvbiAtPSBkZWx0YTtcblxuICAgIGlmKHRvbmUuZHVyYXRpb24gPCAwKSB7XG4gICAgICAvL3RvbmUuZ2Fpbi5nYWluLnZhbHVlID0gMFxuICAgICAgdG9EZXF1ZXVlKys7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgY29uc3QgZnJhYyA9ICh0b25lLmR1cmF0aW9uIC8gdG9uZS5pbml0RHVyYXRpb24pICogdG9uZS52b2x1bWU7XG4gICAgICAvL2xldCdzIHVzZSBleHBvbmVudGlhbCBpbnN0ZWFkIG9mIGxpbmVhciBnYWluLlxuICAgICAgdG9uZS5nYWluLmdhaW4udmFsdWUgPSBmcmFjICogZnJhYztcbiAgICB9XG4gIH1cblxuICB3aGlsZSh0b0RlcXVldWUgPiAwKSB7XG4gICAgLy9hY3RpdmVzIHNob3VsZCBiZSBvcmRlcmVkIGJ5IGR1cmF0aW9uLCBzbyB3ZSBjYW4ganVzdCBzaGlmdCBmcm9tIHRoZSBmcm9udCB0byBkZXF1ZXVlIHRoZW0uXG4gICAgY29uc3QgZGVxID0gYXVkaW8uYWN0aXZlcy5zaGlmdCgpO1xuICAgIGRlcS5vc2Muc3RvcCgwKTtcbiAgICBkZXEub3NjLmRpc2Nvbm5lY3QoKTtcbiAgICBkZXEuZ2Fpbi5kaXNjb25uZWN0KCk7XG4gICAgZGVsZXRlIGRlcS5vc2M7XG4gICAgZGVsZXRlIGRlcS5nYWluO1xuICAgIC8vYXVkaW8ucG9vbC5wdXNoKClcbiAgICB0b0RlcXVldWUtLTtcbiAgfVxufVxuXG4vL1RPRE86IGhhbmRsZSBwYW4gdXNpbmcgYSBQYW5uZXJOb2RlXG5mdW5jdGlvbiBhZGRUb25lKG5vdGUsIHBhbiwgdm9sdW1lKSB7XG4gIGlmKGF1ZGlvLmFjdGl2ZXMubGVuZ3RoID4gOCkge1xuICAgIHJldHVybjtcbiAgfVxuICAvL3RvbmUgPSBhdWRpby5wb29sLnBvcCgpXG4gIGxldCB0b25lID0gbnVsbDtcbiAgaWYoIXRvbmUpIHtcbiAgICBjb25zdCBvc2MgPSBhdWRpby5jdHguY3JlYXRlT3NjaWxsYXRvcigpO1xuICAgIG9zYy50eXBlID0gJ3NpbmUnO1xuXG4gICAgY29uc3QgZ2FpbiA9IGF1ZGlvLmN0eC5jcmVhdGVHYWluKCk7XG4gICAgb3NjLmNvbm5lY3QoZ2Fpbik7XG4gICAgZ2Fpbi5jb25uZWN0KGF1ZGlvLmN0eC5kZXN0aW5hdGlvbik7XG4gICAgXG4gICAgdG9uZSA9IHtcbiAgICAgIG9zYzogb3NjLFxuICAgICAgZ2FpbjogZ2FpblxuICAgIH07XG4gIH1cblxuICB0b25lLmR1cmF0aW9uID0gMTAwMDtcbiAgdG9uZS5pbml0RHVyYXRpb24gPSB0b25lLmR1cmF0aW9uO1xuXG4gIHRvbmUudm9sdW1lID0gdm9sdW1lO1xuICB0b25lLmdhaW4uZ2Fpbi52YWx1ZSA9IHRvbmUudm9sdW1lO1xuXG4gIHRvbmUub3NjLmZyZXF1ZW5jeS52YWx1ZSA9IDQ0MCAqIE1hdGgucG93KDIsIChub3RlIC8gMTIpIC0gMSk7XG5cbiAgdG9uZS5vc2Muc3RhcnQoMCk7XG5cbiAgYXVkaW8uYWN0aXZlcy5wdXNoKHRvbmUpO1xufVxuXG5mdW5jdGlvbiBvbk1vdXNlTW92ZShldmVudCkge1xuICBpZihjaG9yZENoYW5nZVRpbWVvdXQgPCAwKSB7XG4gICAgY2hvcmRJbmRleCA9IChjaG9yZEluZGV4ICsgMSkgJSBjb25maWcuY2hvcmRMaXN0Lmxlbmd0aDtcbiAgICBzZXRDaG9yZChjaG9yZEluZGV4KTtcbiAgfVxuXG4gIGNob3JkQ2hhbmdlVGltZW91dCA9IGNvbmZpZy5jaG9yZENoYW5nZVRpbWVvdXQ7XG59XG5cbmZ1bmN0aW9uIHNldENob3JkKGluZGV4KSB7XG4gIGNvbnN0IGNob3JkTm90ZXMgPSBjb25maWcuY2hvcmRMaXN0W2luZGV4XTtcblxuICBzY2FsZSA9IFtdO1xuXG4gIG5vdGVzLmZvckVhY2goKG5vdGUsIGkpID0+IHtcbiAgICBpZihjaG9yZE5vdGVzLmluZGV4T2Yobm90ZSkgIT09IC0xKSB7XG4gICAgICBzY2FsZS5wdXNoKGkpO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGFkZERvdCgpIHtcbiAgY29uc3QgZG90ID0gbmV3IGNyZWF0ZWpzLlBvaW50KFxuICAgIE1hdGgucmFuZG9tKCkgKiBjYW52YXMud2lkdGgsXG4gICAgTWF0aC5yYW5kb20oKSAqIGNhbnZhcy5oZWlnaHRcbiAgKTtcblxuICBkb3QudmVsb2NpdHkgPSBuZXcgY3JlYXRlanMuUG9pbnQoMCwgMCk7XG4gIGRvdC5jb250YWN0VGltZW91dCA9IGNvbmZpZy5jb250YWN0VGltZW91dDtcblxuICBkb3RzLnB1c2goZG90KTtcbn1cblxuZnVuY3Rpb24gd3JhcFRvU3RhZ2UoZG90KSB7XG4gIGlmIChkb3QueCA8IDApIHtcbiAgICBkb3QueCArPSBjYW52YXMud2lkdGg7XG4gIH1cbiAgZWxzZSBpZiAoZG90LnggPiBjYW52YXMud2lkdGgpIHtcbiAgICBkb3QueCAtPSBjYW52YXMud2lkdGg7XG4gIH1cbiAgaWYgKGRvdC55IDwgMCkge1xuICAgIGRvdC55ICs9IGNhbnZhcy5oZWlnaHQ7XG4gIH1cbiAgZWxzZSBpZiAoZG90LnkgPiBjYW52YXMuaGVpZ2h0KSB7XG4gICAgZG90LnkgLT0gY2FudmFzLmhlaWdodDtcbiAgfVxufVxuXG5mdW5jdGlvbiBjbGFtcCh2YWwsIG1pbiwgbWF4KSB7XG4gIHJldHVybiBNYXRoLm1heChtaW4sIE1hdGgubWluKG1heCwgdmFsKSk7XG59XG5cbiJdfQ==