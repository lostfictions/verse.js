/* @flow weak */

//verse.js
//2014 - 2015

/*global createjs */

'use strict';

var notes = ['e', 'f', 'f#', 'g', 'g#', 'a', 'a#', 'b', 'c', 'c#', 'd', 'd#', 'e', 'f', 'f#', 'g', 'g#', 'a', 'a#', 'b', 'c', 'c#', 'd', 'd#', 'e', 'f', 'f#', 'g', 'g#', 'a', 'a#', 'b', 'c', 'c#', 'd', 'd#', 'e'];

var config = {
  bufferSize: 2048,
  maxDotFactor: 60 / 500000,
  maxMouseDistance: 100,
  maxContactDistance: 50,
  contactTimeout: 400,
  contactVelocityFactor: 0.5,
  dotSpeedThreshold: 10,
  dotDeceleration: 0.99,
  fadeFactor: 0.05,
  chordChangeTimeout: 5000,
  dotAddRemoveTimeout: 100,
  noteTriggerTimeout: 50,
  chordList: ['e, c, g', 'e, b, g']
};

var audio = {
  actives: [],
  pool: [],
  ctx: null,
  generator: null
};

var maxDotCount = 1;

var dots = [];

var lastMouse = {
  x: 0,
  y: 0
};

var chordChangeTimeout = 0;
var dotAddRemoveTimeout = 0;
var noteTriggerTimeout = 0;
var chordIndex = 0;
var scale = [];

var fadeRect = undefined;
var canvas = undefined;
var stage = undefined;
var drawingCanvas = undefined;

function init() {
  canvas = document.getElementById('mainCanvas');

  stage = new createjs.Stage(canvas);
  stage.autoClear = false;
  stage.enableDOMEvents(true);

  createjs.Touch.enable(stage);

  createjs.Ticker.timingMode = createjs.Ticker.RAF_SYNCHED;
  createjs.Ticker.setFPS(60);

  canvas.setAttribute('style', 'background-color: #000000');

  drawingCanvas = new createjs.Shape();
  stage.addChild(drawingCanvas);

  fadeRect = new createjs.Shape();
  stage.addChild(fadeRect);

  setChord(chordIndex);

  //audio stuff.
  var AudioContext = window.AudioContext || window.webkitAudioContext;
  if (!AudioContext) {
    console.log('audio api not available!');
    //TODO: do something smart to handle the api not being available.
    return;
  }

  audio.ctx = new AudioContext();
  audio.generator = audio.ctx.createScriptProcessor(config.bufferSize, 0, 2);
  audio.generator.onaudioprocess = processAudio;
  audio.generator.connect(audio.ctx.destination);

  window.addEventListener('resize', onResize);
  onResize();
  stage.addEventListener('stagemousemove', onMouseMove);
  createjs.Ticker.addEventListener('tick', onTick);
}

function onResize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  fadeRect.graphics.clear().beginFill('rgba(0,0,0,' + config.fadeFactor + ')').rect(0, 0, canvas.width, canvas.height);

  maxDotCount = Math.round(config.maxDotFactor * canvas.width * canvas.height);
  console.log('maxDotCount: ' + maxDotCount);
}

//TODO: should be okay to not use our delta time everywhere because our ticker
//mode is RAF_SYNCHED, but we should do it anyway.
function onTick(event) {
  chordChangeTimeout -= event.delta;
  dotAddRemoveTimeout -= event.delta;
  noteTriggerTimeout -= event.delta;

  var dMouseX = stage.mouseX - lastMouse.x;
  var dMouseY = stage.mouseY - lastMouse.y;

  if (dotAddRemoveTimeout < 0) {
    dotAddRemoveTimeout = config.dotAddRemoveTimeout;
    if (dots.length < maxDotCount) {
      addDot();
    } else if (dots.length > maxDotCount) {
      dots.pop();
    }
  }

  var g = drawingCanvas.graphics;

  g.clear().setStrokeStyle(1).beginStroke('#ffffff');

  var wasNotePlayed = false;

  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = dots[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      var dot = _step.value;

      g.moveTo(dot.x, dot.y);
      dot.x += dot.velocity.x;
      dot.y += dot.velocity.y;
      g.lineTo(dot.x, dot.y);

      wrapToStage(dot);

      dot.contactTimeout -= event.delta;

      var _iteratorNormalCompletion2 = true;
      var _didIteratorError2 = false;
      var _iteratorError2 = undefined;

      try {
        for (var _iterator2 = dots[Symbol.iterator](), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
          var otherDot = _step2.value;

          if (otherDot === dot) {
            continue;
          }

          var dx = dot.x - otherDot.x;
          var dy = dot.y - otherDot.y;
          var dist = Math.sqrt(dx * dx + dy * dy);

          if (dist > config.maxContactDistance) {
            continue;
          }

          if (dist > 0) {
            var vf = config.contactVelocityFactor;
            dot.velocity.x += vf * dx / dist;
            dot.velocity.y += vf * dy / dist;
            otherDot.velocity.x -= vf * dx / dist;
            otherDot.velocity.y -= vf * dy / dist;
          }

          if (dot.contactTimeout < 0) {
            dot.contactTimeout = config.contactTimeout;

            g.moveTo(dot.x, dot.y).lineTo(otherDot.x, otherDot.y);

            if (!wasNotePlayed && noteTriggerTimeout < 0) {
              wasNotePlayed = true;
              noteTriggerTimeout = config.noteTriggerTimeout;

              var avgYPos = (dot.y + otherDot.y) / 2;
              var indScale = Math.round(Math.random() * 2) * 2 - 1 + scale.length - 1 - Math.round(scale.length * avgYPos / canvas.height);
              indScale = clamp(indScale, 0, scale.length - 1);

              var avgXPos = (dot.x + otherDot.x) / 2;
              var pan = avgXPos / (canvas.width * 0.5) - 1;

              var avgXVel = (Math.abs(dot.velocity.x) + Math.abs(otherDot.velocity.x)) / 2;
              var avgYVel = (Math.abs(dot.velocity.y) + Math.abs(otherDot.velocity.y)) / 2;

              var avgVelocity = Math.sqrt(avgXVel * avgXVel + avgYVel * avgYVel);
              avgVelocity = clamp(avgVelocity, 0, config.dotSpeedThreshold);

              var volume = 0.2 + 0.8 * (avgVelocity / config.dotSpeedThreshold);

              var note = scale[indScale];

              addTone(note, pan, volume);
            }
          }
        }
      } catch (err) {
        _didIteratorError2 = true;
        _iteratorError2 = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion2 && _iterator2['return']) {
            _iterator2['return']();
          }
        } finally {
          if (_didIteratorError2) {
            throw _iteratorError2;
          }
        }
      }

      //done iterating through other dots.

      var dX = dot.x - stage.mouseX;
      var dY = dot.y - stage.mouseY;

      var distMouse = Math.sqrt(dX * dX + dY * dY);

      if (distMouse < config.maxMouseDistance) {
        dot.velocity.x += 0.001 * (config.maxMouseDistance - distMouse) * dMouseX;
        dot.velocity.y += 0.001 * (config.maxMouseDistance - distMouse) * dMouseY;
      }

      var speed = Math.sqrt(dot.velocity.x * dot.velocity.x + dot.velocity.y * dot.velocity.y);
      if (speed > config.dotSpeedThreshold) {
        dot.velocity.x = config.dotSpeedThreshold * dot.velocity.x / speed;
        dot.velocity.y = config.dotSpeedThreshold * dot.velocity.y / speed;
      }

      dot.velocity.x *= config.dotDeceleration;
      dot.velocity.y *= config.dotDeceleration;
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator['return']) {
        _iterator['return']();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }

  lastMouse.x = stage.mouseX;
  lastMouse.y = stage.mouseY;

  stage.update();
}

function processAudio(e) {
  var left = e.outputBuffer.getChannelData(0);
  var right = e.outputBuffer.getChannelData(1);

  //these buffers ain't clean!
  for (var i = 0; i < config.bufferSize; i++) {
    left[i] = 0;
    right[i] = 0;
  }

  for (var j = audio.actives.length - 1; j >= 0; j--) {
    var tone = audio.actives[j];
    for (var i = 0; i < config.bufferSize; i++) {
      if (tone.duration <= 0) {
        continue;
      }

      //i don't really get what these next few values mean. they basically look like magic numbers to me.
      var env = tone.duration / 20000;

      var amp = undefined;
      if (tone.phase < 0.5) {
        var tmp = tone.phase * 4 - 1;
        amp = (1 - tmp * tmp) * env * env * 0.5;
      } else {
        var tmp = tone.phase * 4 - 3;
        amp = (tmp * tmp - 1) * env * env * 0.5;
      }

      tone.phase += tone.freq;

      if (tone.phase >= 1) {
        tone.phase--;
      }

      left[i] += amp * tone.gainL;
      right[i] += amp * tone.gainR;

      tone.duration--;
    }
    if (tone.duration <= 0) {
      audio.actives.splice(j, 1);
    }
  }

  //console.log('left: ' + (left.reduce((p, c) => p + c) / left.length));
}

function addTone(note, pan, volume) {
  var tone = {
    duration: 1 * 44100,
    freq: 440 * Math.pow(2, note / 12 - 1) / 44100,
    phase: 0,
    gainL: (1 - pan) * volume,
    gainR: (pan + 1) * volume
  };

  audio.actives.push(tone);
}

function onMouseMove(event) {
  if (chordChangeTimeout < 0) {
    chordIndex = (chordIndex + 1) % config.chordList.length;
    setChord(chordIndex);
  }

  chordChangeTimeout = config.chordChangeTimeout;
}

function setChord(index) {
  var chordNotes = config.chordList[index];

  scale = [];

  notes.forEach(function (note, i) {
    if (chordNotes.indexOf(note) !== -1) {
      scale.push(i);
    }
  });
}

function addDot() {
  var dot = new createjs.Point(Math.random() * canvas.width, Math.random() * canvas.height);

  dot.velocity = new createjs.Point(0, 0);
  dot.contactTimeout = config.contactTimeout;

  dots.push(dot);
}

function wrapToStage(dot) {
  if (dot.x < 0) {
    dot.x += canvas.width;
  } else if (dot.x > canvas.width) {
    dot.x -= canvas.width;
  }
  if (dot.y < 0) {
    dot.y += canvas.height;
  } else if (dot.y > canvas.height) {
    dot.y -= canvas.height;
  }
}

function clamp(val, min, max) {
  return Math.max(min, Math.min(max, val));
}

//# sourceMappingURL=data:application/json;base64,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RyxNQUFNLENBQUMsS0FBSyxFQUM1QixJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FDOUIsQ0FBQzs7QUFFRixLQUFHLENBQUMsUUFBUSxHQUFHLElBQUksUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFDeEMsS0FBRyxDQUFDLGNBQWMsR0FBRyxNQUFNLENBQUMsY0FBYyxDQUFDOztBQUUzQyxNQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0NBQ2hCOztBQUVELFNBQVMsV0FBVyxDQUFDLEdBQUcsRUFBRTtBQUN4QixNQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFO0FBQ1osT0FBRyxDQUFDLENBQUMsSUFBSSxNQUFNLENBQUMsS0FBSyxDQUFDO0dBQ3ZCLE1BQ0ksSUFBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxLQUFLLEVBQUU7QUFDNUIsT0FBRyxDQUFDLENBQUMsSUFBSSxNQUFNLENBQUMsS0FBSyxDQUFDO0dBQ3ZCO0FBQ0QsTUFBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRTtBQUNaLE9BQUcsQ0FBQyxDQUFDLElBQUksTUFBTSxDQUFDLE1BQU0sQ0FBQztHQUN4QixNQUNJLElBQUcsR0FBRyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsTUFBTSxFQUFFO0FBQzdCLE9BQUcsQ0FBQyxDQUFDLElBQUksTUFBTSxDQUFDLE1BQU0sQ0FBQztHQUN4QjtDQUNGOztBQUVELFNBQVMsS0FBSyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFO0FBQzVCLFNBQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztDQUMxQyIsImZpbGUiOiJ2ZXJzZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIEBmbG93IHdlYWsgKi9cblxuLy92ZXJzZS5qc1xuLy8yMDE0IC0gMjAxNVxuXG4vKmdsb2JhbCBjcmVhdGVqcyAqL1xuXG5jb25zdCBub3RlcyA9IFtcbiAgJ2UnLCAnZicsICdmIycsICdnJywgJ2cjJyxcbiAgJ2EnLCAnYSMnLCAnYicsICdjJywgJ2MjJyxcbiAgJ2QnLCAnZCMnLCAnZScsICdmJywgJ2YjJyxcbiAgJ2cnLCAnZyMnLCAnYScsICdhIycsICdiJyxcbiAgJ2MnLCAnYyMnLCAnZCcsICdkIycsICdlJyxcbiAgJ2YnLCAnZiMnLCAnZycsICdnIycsICdhJyxcbiAgJ2EjJywgJ2InLCAnYycsICdjIycsICdkJyxcbiAgJ2QjJywgJ2UnXG5dO1xuXG5jb25zdCBjb25maWcgPSB7XG4gIGJ1ZmZlclNpemU6IDIwNDgsXG4gIG1heERvdEZhY3RvcjogNjAgLyA1MDAwMDAsXG4gIG1heE1vdXNlRGlzdGFuY2U6IDEwMCxcbiAgbWF4Q29udGFjdERpc3RhbmNlOiA1MCxcbiAgY29udGFjdFRpbWVvdXQ6IDQwMCxcbiAgY29udGFjdFZlbG9jaXR5RmFjdG9yOiAwLjUsXG4gIGRvdFNwZWVkVGhyZXNob2xkOiAxMCxcbiAgZG90RGVjZWxlcmF0aW9uOiAwLjk5LFxuICBmYWRlRmFjdG9yOiAwLjA1LFxuICBjaG9yZENoYW5nZVRpbWVvdXQ6IDUwMDAsXG4gIGRvdEFkZFJlbW92ZVRpbWVvdXQ6IDEwMCxcbiAgbm90ZVRyaWdnZXJUaW1lb3V0OiA1MCxcbiAgY2hvcmRMaXN0OiBbJ2UsIGMsIGcnLCAnZSwgYiwgZyddXG59O1xuXG5jb25zdCBhdWRpbyA9IHtcbiAgYWN0aXZlczogW10sXG4gIHBvb2w6IFtdLFxuICBjdHg6IG51bGwsXG4gIGdlbmVyYXRvcjogbnVsbFxufTtcblxubGV0IG1heERvdENvdW50ID0gMTtcblxubGV0IGRvdHMgPSBbXTtcblxubGV0IGxhc3RNb3VzZSA9IHtcbiAgeDogMCxcbiAgeTogMFxufTtcblxubGV0IGNob3JkQ2hhbmdlVGltZW91dCA9IDA7XG5sZXQgZG90QWRkUmVtb3ZlVGltZW91dCA9IDA7XG5sZXQgbm90ZVRyaWdnZXJUaW1lb3V0ID0gMDtcbmxldCBjaG9yZEluZGV4ID0gMDtcbmxldCBzY2FsZSA9IFtdO1xuXG5sZXQgZmFkZVJlY3Q7XG5sZXQgY2FudmFzO1xubGV0IHN0YWdlO1xubGV0IGRyYXdpbmdDYW52YXM7XG5cbmZ1bmN0aW9uIGluaXQoKSB7XG4gIGNhbnZhcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYWluQ2FudmFzJyk7XG5cbiAgc3RhZ2UgPSBuZXcgY3JlYXRlanMuU3RhZ2UoY2FudmFzKTtcbiAgc3RhZ2UuYXV0b0NsZWFyID0gZmFsc2U7XG4gIHN0YWdlLmVuYWJsZURPTUV2ZW50cyh0cnVlKTtcblxuICBjcmVhdGVqcy5Ub3VjaC5lbmFibGUoc3RhZ2UpO1xuXG4gIGNyZWF0ZWpzLlRpY2tlci50aW1pbmdNb2RlID0gY3JlYXRlanMuVGlja2VyLlJBRl9TWU5DSEVEO1xuICBjcmVhdGVqcy5UaWNrZXIuc2V0RlBTKDYwKTtcblxuICBjYW52YXMuc2V0QXR0cmlidXRlKCdzdHlsZScsICdiYWNrZ3JvdW5kLWNvbG9yOiAjMDAwMDAwJyk7XG5cbiAgZHJhd2luZ0NhbnZhcyA9IG5ldyBjcmVhdGVqcy5TaGFwZSgpO1xuICBzdGFnZS5hZGRDaGlsZChkcmF3aW5nQ2FudmFzKTtcblxuICBmYWRlUmVjdCA9IG5ldyBjcmVhdGVqcy5TaGFwZSgpO1xuICBzdGFnZS5hZGRDaGlsZChmYWRlUmVjdCk7XG5cbiAgc2V0Q2hvcmQoY2hvcmRJbmRleCk7XG5cbiAgLy9hdWRpbyBzdHVmZi5cbiAgY29uc3QgQXVkaW9Db250ZXh0ID0gd2luZG93LkF1ZGlvQ29udGV4dCB8fCB3aW5kb3cud2Via2l0QXVkaW9Db250ZXh0O1xuICBpZighQXVkaW9Db250ZXh0KSB7XG4gICAgY29uc29sZS5sb2coJ2F1ZGlvIGFwaSBub3QgYXZhaWxhYmxlIScpO1xuICAgIC8vVE9ETzogZG8gc29tZXRoaW5nIHNtYXJ0IHRvIGhhbmRsZSB0aGUgYXBpIG5vdCBiZWluZyBhdmFpbGFibGUuXG4gICAgcmV0dXJuO1xuICB9XG4gIFxuICBhdWRpby5jdHggPSBuZXcgQXVkaW9Db250ZXh0KCk7XG4gIGF1ZGlvLmdlbmVyYXRvciA9IGF1ZGlvLmN0eC5jcmVhdGVTY3JpcHRQcm9jZXNzb3IoY29uZmlnLmJ1ZmZlclNpemUsIDAsIDIpO1xuICBhdWRpby5nZW5lcmF0b3Iub25hdWRpb3Byb2Nlc3MgPSBwcm9jZXNzQXVkaW87XG4gIGF1ZGlvLmdlbmVyYXRvci5jb25uZWN0KGF1ZGlvLmN0eC5kZXN0aW5hdGlvbik7XG5cbiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIG9uUmVzaXplKTtcbiAgb25SZXNpemUoKTtcbiAgc3RhZ2UuYWRkRXZlbnRMaXN0ZW5lcignc3RhZ2Vtb3VzZW1vdmUnLCBvbk1vdXNlTW92ZSk7XG4gIGNyZWF0ZWpzLlRpY2tlci5hZGRFdmVudExpc3RlbmVyKCd0aWNrJywgb25UaWNrKTtcbn1cblxuZnVuY3Rpb24gb25SZXNpemUoKSB7XG4gIGNhbnZhcy53aWR0aCA9IHdpbmRvdy5pbm5lcldpZHRoO1xuICBjYW52YXMuaGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0O1xuICBmYWRlUmVjdC5ncmFwaGljc1xuICAgIC5jbGVhcigpXG4gICAgLmJlZ2luRmlsbChgcmdiYSgwLDAsMCwkeyBjb25maWcuZmFkZUZhY3RvciB9KWApXG4gICAgLnJlY3QoMCwgMCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTtcblxuICBtYXhEb3RDb3VudCA9IE1hdGgucm91bmQoY29uZmlnLm1heERvdEZhY3RvciAqIGNhbnZhcy53aWR0aCAqIGNhbnZhcy5oZWlnaHQpO1xuICBjb25zb2xlLmxvZygnbWF4RG90Q291bnQ6ICcgKyBtYXhEb3RDb3VudCk7XG59XG5cbi8vVE9ETzogc2hvdWxkIGJlIG9rYXkgdG8gbm90IHVzZSBvdXIgZGVsdGEgdGltZSBldmVyeXdoZXJlIGJlY2F1c2Ugb3VyIHRpY2tlclxuLy9tb2RlIGlzIFJBRl9TWU5DSEVELCBidXQgd2Ugc2hvdWxkIGRvIGl0IGFueXdheS5cbmZ1bmN0aW9uIG9uVGljayhldmVudCkge1xuICBjaG9yZENoYW5nZVRpbWVvdXQgLT0gZXZlbnQuZGVsdGE7XG4gIGRvdEFkZFJlbW92ZVRpbWVvdXQgLT0gZXZlbnQuZGVsdGE7XG4gIG5vdGVUcmlnZ2VyVGltZW91dCAtPSBldmVudC5kZWx0YTtcblxuICBjb25zdCBkTW91c2VYID0gc3RhZ2UubW91c2VYIC0gbGFzdE1vdXNlLng7XG4gIGNvbnN0IGRNb3VzZVkgPSBzdGFnZS5tb3VzZVkgLSBsYXN0TW91c2UueTtcblxuICBpZihkb3RBZGRSZW1vdmVUaW1lb3V0IDwgMCkge1xuICAgIGRvdEFkZFJlbW92ZVRpbWVvdXQgPSBjb25maWcuZG90QWRkUmVtb3ZlVGltZW91dDtcbiAgICBpZihkb3RzLmxlbmd0aCA8IG1heERvdENvdW50KSB7XG4gICAgICBhZGREb3QoKTtcbiAgICB9XG4gICAgZWxzZSBpZihkb3RzLmxlbmd0aCA+IG1heERvdENvdW50KSB7XG4gICAgICBkb3RzLnBvcCgpO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0IGcgPSBkcmF3aW5nQ2FudmFzLmdyYXBoaWNzO1xuXG4gIGdcbiAgICAuY2xlYXIoKVxuICAgIC5zZXRTdHJva2VTdHlsZSgxKVxuICAgIC5iZWdpblN0cm9rZSgnI2ZmZmZmZicpO1xuXG5cbiAgbGV0IHdhc05vdGVQbGF5ZWQgPSBmYWxzZTtcblxuICBmb3IoY29uc3QgZG90IG9mIGRvdHMpIHtcbiAgICBnLm1vdmVUbyhkb3QueCwgZG90LnkpO1xuICAgIGRvdC54ICs9IGRvdC52ZWxvY2l0eS54O1xuICAgIGRvdC55ICs9IGRvdC52ZWxvY2l0eS55O1xuICAgIGcubGluZVRvKGRvdC54LCBkb3QueSk7XG5cbiAgICB3cmFwVG9TdGFnZShkb3QpO1xuXG4gICAgZG90LmNvbnRhY3RUaW1lb3V0IC09IGV2ZW50LmRlbHRhO1xuXG4gICAgZm9yKGNvbnN0IG90aGVyRG90IG9mIGRvdHMpIHtcbiAgICAgIGlmKG90aGVyRG90ID09PSBkb3QpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGR4ID0gZG90LnggLSBvdGhlckRvdC54O1xuICAgICAgY29uc3QgZHkgPSBkb3QueSAtIG90aGVyRG90Lnk7XG4gICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGR4ICogZHggKyBkeSAqIGR5KTtcblxuICAgICAgaWYoZGlzdCA+IGNvbmZpZy5tYXhDb250YWN0RGlzdGFuY2UpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGlmKGRpc3QgPiAwKSB7XG4gICAgICAgIGNvbnN0IHZmID0gY29uZmlnLmNvbnRhY3RWZWxvY2l0eUZhY3RvcjtcbiAgICAgICAgZG90LnZlbG9jaXR5LnggKz0gdmYgKiBkeCAvIGRpc3Q7XG4gICAgICAgIGRvdC52ZWxvY2l0eS55ICs9IHZmICogZHkgLyBkaXN0O1xuICAgICAgICBvdGhlckRvdC52ZWxvY2l0eS54IC09IHZmICogZHggLyBkaXN0O1xuICAgICAgICBvdGhlckRvdC52ZWxvY2l0eS55IC09IHZmICogZHkgLyBkaXN0O1xuICAgICAgfVxuXG4gICAgICBpZihkb3QuY29udGFjdFRpbWVvdXQgPCAwKSB7XG4gICAgICAgIGRvdC5jb250YWN0VGltZW91dCA9IGNvbmZpZy5jb250YWN0VGltZW91dDtcblxuICAgICAgICBnXG4gICAgICAgICAgLm1vdmVUbyhkb3QueCwgZG90LnkpXG4gICAgICAgICAgLmxpbmVUbyhvdGhlckRvdC54LCBvdGhlckRvdC55KTtcblxuICAgICAgICBpZighd2FzTm90ZVBsYXllZCAmJiBub3RlVHJpZ2dlclRpbWVvdXQgPCAwKSB7XG4gICAgICAgICAgd2FzTm90ZVBsYXllZCA9IHRydWU7XG4gICAgICAgICAgbm90ZVRyaWdnZXJUaW1lb3V0ID0gY29uZmlnLm5vdGVUcmlnZ2VyVGltZW91dDtcblxuICAgICAgICAgIGNvbnN0IGF2Z1lQb3MgPSAoZG90LnkgKyBvdGhlckRvdC55KSAvIDI7XG4gICAgICAgICAgbGV0IGluZFNjYWxlID0gTWF0aC5yb3VuZChNYXRoLnJhbmRvbSgpICogMiApICogMiAtIDEgK1xuICAgICAgICAgICAgc2NhbGUubGVuZ3RoIC0gMSAtIE1hdGgucm91bmQoc2NhbGUubGVuZ3RoICogYXZnWVBvcyAvIGNhbnZhcy5oZWlnaHQpO1xuICAgICAgICAgIGluZFNjYWxlID0gY2xhbXAoaW5kU2NhbGUsIDAsIHNjYWxlLmxlbmd0aCAtIDEpO1xuXG4gICAgICAgICAgY29uc3QgYXZnWFBvcyA9IChkb3QueCArIG90aGVyRG90LngpIC8gMjtcbiAgICAgICAgICBjb25zdCBwYW4gPSBhdmdYUG9zIC8gKGNhbnZhcy53aWR0aCAqIDAuNSkgLSAxO1xuXG4gICAgICAgICAgY29uc3QgYXZnWFZlbCA9IChNYXRoLmFicyhkb3QudmVsb2NpdHkueCkgKyBNYXRoLmFicyhvdGhlckRvdC52ZWxvY2l0eS54KSkgLyAyO1xuICAgICAgICAgIGNvbnN0IGF2Z1lWZWwgPSAoTWF0aC5hYnMoZG90LnZlbG9jaXR5LnkpICsgTWF0aC5hYnMob3RoZXJEb3QudmVsb2NpdHkueSkpIC8gMjtcblxuICAgICAgICAgIGxldCBhdmdWZWxvY2l0eSA9IE1hdGguc3FydChhdmdYVmVsICogYXZnWFZlbCArIGF2Z1lWZWwgKiBhdmdZVmVsKTtcbiAgICAgICAgICBhdmdWZWxvY2l0eSA9IGNsYW1wKGF2Z1ZlbG9jaXR5LCAwLCBjb25maWcuZG90U3BlZWRUaHJlc2hvbGQpO1xuXG4gICAgICAgICAgY29uc3Qgdm9sdW1lID0gMC4yICsgMC44ICogKGF2Z1ZlbG9jaXR5IC8gY29uZmlnLmRvdFNwZWVkVGhyZXNob2xkKTtcblxuICAgICAgICAgIGNvbnN0IG5vdGUgPSBzY2FsZVtpbmRTY2FsZV07XG5cbiAgICAgICAgICBhZGRUb25lKG5vdGUsIHBhbiwgdm9sdW1lKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gLy9kb25lIGl0ZXJhdGluZyB0aHJvdWdoIG90aGVyIGRvdHMuXG5cbiAgICBjb25zdCBkWCA9IGRvdC54IC0gc3RhZ2UubW91c2VYO1xuICAgIGNvbnN0IGRZID0gZG90LnkgLSBzdGFnZS5tb3VzZVk7XG5cbiAgICBjb25zdCBkaXN0TW91c2UgPSBNYXRoLnNxcnQoZFggKiBkWCArIGRZICogZFkpO1xuXG4gICAgaWYoZGlzdE1vdXNlIDwgY29uZmlnLm1heE1vdXNlRGlzdGFuY2UpIHtcbiAgICAgIGRvdC52ZWxvY2l0eS54ICs9IDAuMDAxICogKGNvbmZpZy5tYXhNb3VzZURpc3RhbmNlIC0gZGlzdE1vdXNlKSAqIGRNb3VzZVg7XG4gICAgICBkb3QudmVsb2NpdHkueSArPSAwLjAwMSAqIChjb25maWcubWF4TW91c2VEaXN0YW5jZSAtIGRpc3RNb3VzZSkgKiBkTW91c2VZO1xuICAgIH1cblxuICAgIGNvbnN0IHNwZWVkID0gTWF0aC5zcXJ0KGRvdC52ZWxvY2l0eS54ICogZG90LnZlbG9jaXR5LnggKyBkb3QudmVsb2NpdHkueSAqIGRvdC52ZWxvY2l0eS55KTtcbiAgICBpZihzcGVlZCA+IGNvbmZpZy5kb3RTcGVlZFRocmVzaG9sZCkge1xuICAgICAgZG90LnZlbG9jaXR5LnggPSBjb25maWcuZG90U3BlZWRUaHJlc2hvbGQgKiBkb3QudmVsb2NpdHkueCAvIHNwZWVkO1xuICAgICAgZG90LnZlbG9jaXR5LnkgPSBjb25maWcuZG90U3BlZWRUaHJlc2hvbGQgKiBkb3QudmVsb2NpdHkueSAvIHNwZWVkO1xuICAgIH1cblxuICAgIGRvdC52ZWxvY2l0eS54ICo9IGNvbmZpZy5kb3REZWNlbGVyYXRpb247XG4gICAgZG90LnZlbG9jaXR5LnkgKj0gY29uZmlnLmRvdERlY2VsZXJhdGlvbjtcblxuICB9XG5cbiAgbGFzdE1vdXNlLnggPSBzdGFnZS5tb3VzZVg7XG4gIGxhc3RNb3VzZS55ID0gc3RhZ2UubW91c2VZO1xuXG4gIHN0YWdlLnVwZGF0ZSgpO1xufVxuXG5mdW5jdGlvbiBwcm9jZXNzQXVkaW8oZSkge1xuICBjb25zdCBsZWZ0ID0gZS5vdXRwdXRCdWZmZXIuZ2V0Q2hhbm5lbERhdGEoMCk7XG4gIGNvbnN0IHJpZ2h0ID0gZS5vdXRwdXRCdWZmZXIuZ2V0Q2hhbm5lbERhdGEoMSk7XG5cbiAgLy90aGVzZSBidWZmZXJzIGFpbid0IGNsZWFuIVxuICBmb3IobGV0IGkgPSAwOyBpIDwgY29uZmlnLmJ1ZmZlclNpemU7IGkrKykge1xuICAgIGxlZnRbaV0gPSAwO1xuICAgIHJpZ2h0W2ldID0gMDtcbiAgfVxuXG4gIGZvcihsZXQgaiA9IGF1ZGlvLmFjdGl2ZXMubGVuZ3RoIC0gMTsgaiA+PSAwOyBqLS0pIHtcbiAgICBjb25zdCB0b25lID0gYXVkaW8uYWN0aXZlc1tqXTtcbiAgICBmb3IobGV0IGkgPSAwOyBpIDwgY29uZmlnLmJ1ZmZlclNpemU7IGkrKykge1xuICAgICAgaWYodG9uZS5kdXJhdGlvbiA8PSAwKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICAvL2kgZG9uJ3QgcmVhbGx5IGdldCB3aGF0IHRoZXNlIG5leHQgZmV3IHZhbHVlcyBtZWFuLiB0aGV5IGJhc2ljYWxseSBsb29rIGxpa2UgbWFnaWMgbnVtYmVycyB0byBtZS5cbiAgICAgIGNvbnN0IGVudiA9IHRvbmUuZHVyYXRpb24gLyAyMDAwMDtcblxuICAgICAgbGV0IGFtcDtcbiAgICAgIGlmKHRvbmUucGhhc2UgPCAwLjUpIHtcbiAgICAgICAgY29uc3QgdG1wID0gKHRvbmUucGhhc2UgKiA0IC0gMSk7XG4gICAgICAgIGFtcCA9ICgxIC0gdG1wICogdG1wKSAqIGVudiAqIGVudiAqIDAuNTtcbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICBjb25zdCB0bXAgPSAodG9uZS5waGFzZSAqIDQgLSAzKTtcbiAgICAgICAgYW1wID0gKHRtcCAqIHRtcCAtIDEpICogZW52ICogZW52ICogMC41O1xuICAgICAgfVxuXG4gICAgICB0b25lLnBoYXNlICs9IHRvbmUuZnJlcTtcblxuICAgICAgaWYodG9uZS5waGFzZSA+PSAxKSB7XG4gICAgICAgIHRvbmUucGhhc2UtLTtcbiAgICAgIH1cblxuICAgICAgbGVmdFtpXSArPSBhbXAgKiB0b25lLmdhaW5MO1xuICAgICAgcmlnaHRbaV0gKz0gYW1wICogdG9uZS5nYWluUjtcblxuICAgICAgdG9uZS5kdXJhdGlvbi0tO1xuICAgIH1cbiAgICBpZih0b25lLmR1cmF0aW9uIDw9IDApIHtcbiAgICAgIGF1ZGlvLmFjdGl2ZXMuc3BsaWNlKGosIDEpO1xuICAgIH1cbiAgfVxuXG4gIC8vY29uc29sZS5sb2coJ2xlZnQ6ICcgKyAobGVmdC5yZWR1Y2UoKHAsIGMpID0+IHAgKyBjKSAvIGxlZnQubGVuZ3RoKSk7XG59XG5cbmZ1bmN0aW9uIGFkZFRvbmUobm90ZSwgcGFuLCB2b2x1bWUpIHtcbiAgY29uc3QgdG9uZSA9IHtcbiAgICBkdXJhdGlvbjogMSAqIDQ0MTAwLFxuICAgIGZyZXE6IDQ0MCAqIE1hdGgucG93KDIsIChub3RlIC8gMTIpIC0gMSkgLyA0NDEwMCxcbiAgICBwaGFzZTogMCxcbiAgICBnYWluTDogKDEgLSBwYW4pICogdm9sdW1lLFxuICAgIGdhaW5SOiAocGFuICsgMSkgKiB2b2x1bWVcbiAgfTtcblxuICBhdWRpby5hY3RpdmVzLnB1c2godG9uZSk7XG59XG5cbmZ1bmN0aW9uIG9uTW91c2VNb3ZlKGV2ZW50KSB7XG4gIGlmKGNob3JkQ2hhbmdlVGltZW91dCA8IDApIHtcbiAgICBjaG9yZEluZGV4ID0gKGNob3JkSW5kZXggKyAxKSAlIGNvbmZpZy5jaG9yZExpc3QubGVuZ3RoO1xuICAgIHNldENob3JkKGNob3JkSW5kZXgpO1xuICB9XG5cbiAgY2hvcmRDaGFuZ2VUaW1lb3V0ID0gY29uZmlnLmNob3JkQ2hhbmdlVGltZW91dDtcbn1cblxuZnVuY3Rpb24gc2V0Q2hvcmQoaW5kZXgpIHtcbiAgY29uc3QgY2hvcmROb3RlcyA9IGNvbmZpZy5jaG9yZExpc3RbaW5kZXhdO1xuXG4gIHNjYWxlID0gW107XG5cbiAgbm90ZXMuZm9yRWFjaCgobm90ZSwgaSkgPT4ge1xuICAgIGlmKGNob3JkTm90ZXMuaW5kZXhPZihub3RlKSAhPT0gLTEpIHtcbiAgICAgIHNjYWxlLnB1c2goaSk7XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gYWRkRG90KCkge1xuICBjb25zdCBkb3QgPSBuZXcgY3JlYXRlanMuUG9pbnQoXG4gICAgTWF0aC5yYW5kb20oKSAqIGNhbnZhcy53aWR0aCxcbiAgICBNYXRoLnJhbmRvbSgpICogY2FudmFzLmhlaWdodFxuICApO1xuXG4gIGRvdC52ZWxvY2l0eSA9IG5ldyBjcmVhdGVqcy5Qb2ludCgwLCAwKTtcbiAgZG90LmNvbnRhY3RUaW1lb3V0ID0gY29uZmlnLmNvbnRhY3RUaW1lb3V0O1xuXG4gIGRvdHMucHVzaChkb3QpO1xufVxuXG5mdW5jdGlvbiB3cmFwVG9TdGFnZShkb3QpIHtcbiAgaWYoZG90LnggPCAwKSB7XG4gICAgZG90LnggKz0gY2FudmFzLndpZHRoO1xuICB9XG4gIGVsc2UgaWYoZG90LnggPiBjYW52YXMud2lkdGgpIHtcbiAgICBkb3QueCAtPSBjYW52YXMud2lkdGg7XG4gIH1cbiAgaWYoZG90LnkgPCAwKSB7XG4gICAgZG90LnkgKz0gY2FudmFzLmhlaWdodDtcbiAgfVxuICBlbHNlIGlmKGRvdC55ID4gY2FudmFzLmhlaWdodCkge1xuICAgIGRvdC55IC09IGNhbnZhcy5oZWlnaHQ7XG4gIH1cbn1cblxuZnVuY3Rpb24gY2xhbXAodmFsLCBtaW4sIG1heCkge1xuICByZXR1cm4gTWF0aC5tYXgobWluLCBNYXRoLm1pbihtYXgsIHZhbCkpO1xufVxuXG4iXX0=