//verse.js
//2014 - 2015

/*global createjs */

'use strict';

var notes = ['e', 'f', 'f#', 'g', 'g#', 'a', 'a#', 'b', 'c', 'c#', 'd', 'd#', 'e', 'f', 'f#', 'g', 'g#', 'a', 'a#', 'b', 'c', 'c#', 'd', 'd#', 'e', 'f', 'f#', 'g', 'g#', 'a', 'a#', 'b', 'c', 'c#', 'd', 'd#', 'e'];

var config = {
  bufferSize: 2048,
  maxDotFactor: 60 / 500000,
  maxMouseDistance: 100,
  maxContactDistance: 50,
  contactTimeout: 400,
  contactVelocityFactor: 0.5,
  dotSpeedThreshold: 10,
  dotDeceleration: 0.99,
  fadeFactor: 0.05,
  chordChangeTimeout: 5000,
  dotAddRemoveTimeout: 100,
  noteTriggerTimeout: 50,
  chordList: ['e, c, g', 'e, b, g']
};

var audio = {
  actives: [],
  pool: [],
  ctx: null,
  generator: null
};

var maxDotCount = 1;

var dots = [];

var lastMouse = {
  x: 0,
  y: 0
};

var chordChangeTimeout = 0;
var dotAddRemoveTimeout = 0;
var noteTriggerTimeout = 0;
var chordIndex = 0;
var scale = [];

var fadeRect = undefined;
var canvas = undefined;
var stage = undefined;
var drawingCanvas = undefined;

function init() {
  canvas = document.getElementById('mainCanvas');

  stage = new createjs.Stage(canvas);
  stage.autoClear = false;
  stage.enableDOMEvents(true);

  createjs.Touch.enable(stage);

  createjs.Ticker.timingMode = createjs.Ticker.RAF_SYNCHED;
  createjs.Ticker.setFPS(60);

  canvas.setAttribute('style', 'background-color: #000000');

  drawingCanvas = new createjs.Shape();
  stage.addChild(drawingCanvas);

  fadeRect = new createjs.Shape();
  stage.addChild(fadeRect);

  setChord(chordIndex);

  //audio stuff.
  window.AudioContext = window.AudioContext || window.webkitAudioContext;
  if (!window.AudioContext) {
    console.log('audio api not available!');
    //TODO: do something smart to handle the api not being available.
    return;
  } else {
    audio.ctx = new AudioContext();
    audio.generator = audio.ctx.createScriptProcessor(config.bufferSize, 0, 2);
    audio.generator.onaudioprocess = processAudio;
    audio.generator.connect(audio.ctx.destination);
  }

  window.addEventListener('resize', onResize);
  onResize();
  stage.addEventListener('stagemousemove', onMouseMove);
  createjs.Ticker.addEventListener('tick', onTick);
}

function onResize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  fadeRect.graphics.clear().beginFill('rgba(0,0,0,' + config.fadeFactor + ')').rect(0, 0, canvas.width, canvas.height);

  maxDotCount = Math.round(config.maxDotFactor * canvas.width * canvas.height);
  console.log('maxDotCount: ' + maxDotCount);
}

//TODO: should be okay to not use our delta time everywhere because our ticker
//mode is RAF_SYNCHED, but we should do it anyway.
function onTick(event) {
  chordChangeTimeout -= event.delta;
  dotAddRemoveTimeout -= event.delta;
  noteTriggerTimeout -= event.delta;

  var dMouseX = stage.mouseX - lastMouse.x;
  var dMouseY = stage.mouseY - lastMouse.y;

  if (dotAddRemoveTimeout < 0) {
    dotAddRemoveTimeout = config.dotAddRemoveTimeout;
    if (dots.length < maxDotCount) {
      addDot();
    } else if (dots.length > maxDotCount) {
      dots.pop();
    }
  }

  var g = drawingCanvas.graphics;

  g.clear().setStrokeStyle(1).beginStroke('#ffffff');

  var wasNotePlayed = false;

  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = dots[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      var dot = _step.value;

      g.moveTo(dot.x, dot.y);
      dot.x += dot.velocity.x;
      dot.y += dot.velocity.y;
      g.lineTo(dot.x, dot.y);

      wrapToStage(dot);

      dot.contactTimeout -= event.delta;

      var _iteratorNormalCompletion2 = true;
      var _didIteratorError2 = false;
      var _iteratorError2 = undefined;

      try {
        for (var _iterator2 = dots[Symbol.iterator](), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
          var otherDot = _step2.value;

          if (otherDot === dot) {
            continue;
          }

          var dx = dot.x - otherDot.x;
          var dy = dot.y - otherDot.y;
          var dist = Math.sqrt(dx * dx + dy * dy);

          if (dist > config.maxContactDistance) {
            continue;
          }

          if (dist > 0) {
            var vf = config.contactVelocityFactor;
            dot.velocity.x += vf * dx / dist;
            dot.velocity.y += vf * dy / dist;
            otherDot.velocity.x -= vf * dx / dist;
            otherDot.velocity.y -= vf * dy / dist;
          }

          if (dot.contactTimeout < 0) {
            dot.contactTimeout = config.contactTimeout;

            g.moveTo(dot.x, dot.y).lineTo(otherDot.x, otherDot.y);

            if (!wasNotePlayed && noteTriggerTimeout < 0) {
              wasNotePlayed = true;
              noteTriggerTimeout = config.noteTriggerTimeout;

              var avgYPos = (dot.y + otherDot.y) / 2;
              var indScale = Math.round(Math.random() * 2) * 2 - 1 + scale.length - 1 - Math.round(scale.length * avgYPos / canvas.height);
              indScale = clamp(indScale, 0, scale.length - 1);

              var avgXPos = (dot.x + otherDot.x) / 2;
              var pan = avgXPos / (canvas.width * 0.5) - 1;

              var avgXVel = (Math.abs(dot.velocity.x) + Math.abs(otherDot.velocity.x)) / 2;
              var avgYVel = (Math.abs(dot.velocity.y) + Math.abs(otherDot.velocity.y)) / 2;

              var avgVelocity = Math.sqrt(avgXVel * avgXVel + avgYVel * avgYVel);
              avgVelocity = clamp(avgVelocity, 0, config.dotSpeedThreshold);

              var volume = 0.2 + 0.8 * (avgVelocity / config.dotSpeedThreshold);

              var note = scale[indScale];

              addTone(note, pan, volume);
            }
          }
        }
      } catch (err) {
        _didIteratorError2 = true;
        _iteratorError2 = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion2 && _iterator2['return']) {
            _iterator2['return']();
          }
        } finally {
          if (_didIteratorError2) {
            throw _iteratorError2;
          }
        }
      }

      //done iterating through other dots.

      var dX = dot.x - stage.mouseX;
      var dY = dot.y - stage.mouseY;

      var distMouse = Math.sqrt(dX * dX + dY * dY);

      if (distMouse < config.maxMouseDistance) {
        dot.velocity.x += 0.001 * (config.maxMouseDistance - distMouse) * dMouseX;
        dot.velocity.y += 0.001 * (config.maxMouseDistance - distMouse) * dMouseY;
      }

      var speed = Math.sqrt(dot.velocity.x * dot.velocity.x + dot.velocity.y * dot.velocity.y);
      if (speed > config.dotSpeedThreshold) {
        dot.velocity.x = config.dotSpeedThreshold * dot.velocity.x / speed;
        dot.velocity.y = config.dotSpeedThreshold * dot.velocity.y / speed;
      }

      dot.velocity.x *= config.dotDeceleration;
      dot.velocity.y *= config.dotDeceleration;
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator['return']) {
        _iterator['return']();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }

  lastMouse.x = stage.mouseX;
  lastMouse.y = stage.mouseY;

  stage.update();
}

function processAudio(e) {
  var left = e.outputBuffer.getChannelData(0);
  var right = e.outputBuffer.getChannelData(1);

  //these buffers ain't clean!
  for (var i = 0; i < config.bufferSize; i++) {
    left[i] = 0;
    right[i] = 0;
  }

  for (var j = audio.actives.length - 1; j >= 0; j--) {
    var tone = audio.actives[j];
    for (var i = 0; i < config.bufferSize; i++) {
      if (tone.duration <= 0) {
        continue;
      }

      //i don't really get what these next few values mean. they basically look like magic numbers to me.
      var env = tone.duration / 20000;

      var amp = undefined;
      if (tone.phase < 0.5) {
        var tmp = tone.phase * 4 - 1;
        amp = (1 - tmp * tmp) * env * env * 0.5;
      } else {
        var tmp = tone.phase * 4 - 3;
        amp = (tmp * tmp - 1) * env * env * 0.5;
      }

      tone.phase += tone.freq;

      if (tone.phase >= 1) {
        tone.phase--;
      }

      left[i] += amp * tone.gainL;
      right[i] += amp * tone.gainR;

      tone.duration--;
    }
    if (tone.duration <= 0) {
      audio.actives.splice(j, 1);
    }
  }

  //console.log('left: ' + (left.reduce((p, c) => p + c) / left.length));
}

function addTone(note, pan, volume) {
  var tone = {
    duration: 1 * 44100,
    freq: 440 * Math.pow(2, note / 12 - 1) / 44100,
    phase: 0,
    gainL: (1 - pan) * volume,
    gainR: (pan + 1) * volume
  };

  audio.actives.push(tone);
}

function onMouseMove(event) {
  if (chordChangeTimeout < 0) {
    chordIndex = (chordIndex + 1) % config.chordList.length;
    setChord(chordIndex);
  }

  chordChangeTimeout = config.chordChangeTimeout;
}

function setChord(index) {
  var chordNotes = config.chordList[index];

  scale = [];

  notes.forEach(function (note, i) {
    if (chordNotes.indexOf(note) !== -1) {
      scale.push(i);
    }
  });
}

function addDot() {
  var dot = new createjs.Point(Math.random() * canvas.width, Math.random() * canvas.height);

  dot.velocity = new createjs.Point(0, 0);
  dot.contactTimeout = config.contactTimeout;

  dots.push(dot);
}

function wrapToStage(dot) {
  if (dot.x < 0) {
    dot.x += canvas.width;
  } else if (dot.x > canvas.width) {
    dot.x -= canvas.width;
  }
  if (dot.y < 0) {
    dot.y += canvas.height;
  } else if (dot.y > canvas.height) {
    dot.y -= canvas.height;
  }
}

function clamp(val, min, max) {
  return Math.max(min, Math.min(max, val));
}

//# sourceMappingURL=data:application/json;base64,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XG4vKmdsb2JhbCBjcmVhdGVqcyAqL1xuXG5jb25zdCBub3RlcyA9IFtcbiAgJ2UnLCAnZicsICdmIycsICdnJywgJ2cjJyxcbiAgJ2EnLCAnYSMnLCAnYicsICdjJywgJ2MjJyxcbiAgJ2QnLCAnZCMnLCAnZScsICdmJywgJ2YjJyxcbiAgJ2cnLCAnZyMnLCAnYScsICdhIycsICdiJyxcbiAgJ2MnLCAnYyMnLCAnZCcsICdkIycsICdlJyxcbiAgJ2YnLCAnZiMnLCAnZycsICdnIycsICdhJyxcbiAgJ2EjJywgJ2InLCAnYycsICdjIycsICdkJyxcbiAgJ2QjJywgJ2UnXG5dO1xuXG5jb25zdCBjb25maWcgPSB7XG4gIGJ1ZmZlclNpemU6IDIwNDgsXG4gIG1heERvdEZhY3RvcjogNjAgLyA1MDAwMDAsXG4gIG1heE1vdXNlRGlzdGFuY2U6IDEwMCxcbiAgbWF4Q29udGFjdERpc3RhbmNlOiA1MCxcbiAgY29udGFjdFRpbWVvdXQ6IDQwMCxcbiAgY29udGFjdFZlbG9jaXR5RmFjdG9yOiAwLjUsXG4gIGRvdFNwZWVkVGhyZXNob2xkOiAxMCxcbiAgZG90RGVjZWxlcmF0aW9uOiAwLjk5LFxuICBmYWRlRmFjdG9yOiAwLjA1LFxuICBjaG9yZENoYW5nZVRpbWVvdXQ6IDUwMDAsXG4gIGRvdEFkZFJlbW92ZVRpbWVvdXQ6IDEwMCxcbiAgbm90ZVRyaWdnZXJUaW1lb3V0OiA1MCxcbiAgY2hvcmRMaXN0OiBbJ2UsIGMsIGcnLCAnZSwgYiwgZyddXG59O1xuXG5jb25zdCBhdWRpbyA9IHtcbiAgYWN0aXZlczogW10sXG4gIHBvb2w6IFtdLFxuICBjdHg6IG51bGwsXG4gIGdlbmVyYXRvcjogbnVsbFxufTtcblxubGV0IG1heERvdENvdW50ID0gMTtcblxubGV0IGRvdHMgPSBbXTtcblxubGV0IGxhc3RNb3VzZSA9IHtcbiAgeDogMCxcbiAgeTogMFxufTtcblxubGV0IGNob3JkQ2hhbmdlVGltZW91dCA9IDA7XG5sZXQgZG90QWRkUmVtb3ZlVGltZW91dCA9IDA7XG5sZXQgbm90ZVRyaWdnZXJUaW1lb3V0ID0gMDtcbmxldCBjaG9yZEluZGV4ID0gMDtcbmxldCBzY2FsZSA9IFtdO1xuXG5sZXQgZmFkZVJlY3Q7XG5sZXQgY2FudmFzO1xubGV0IHN0YWdlO1xubGV0IGRyYXdpbmdDYW52YXM7XG5cbmZ1bmN0aW9uIGluaXQoKSB7XG4gIGNhbnZhcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYWluQ2FudmFzJyk7XG5cbiAgc3RhZ2UgPSBuZXcgY3JlYXRlanMuU3RhZ2UoY2FudmFzKTtcbiAgc3RhZ2UuYXV0b0NsZWFyID0gZmFsc2U7XG4gIHN0YWdlLmVuYWJsZURPTUV2ZW50cyh0cnVlKTtcblxuICBjcmVhdGVqcy5Ub3VjaC5lbmFibGUoc3RhZ2UpO1xuXG4gIGNyZWF0ZWpzLlRpY2tlci50aW1pbmdNb2RlID0gY3JlYXRlanMuVGlja2VyLlJBRl9TWU5DSEVEO1xuICBjcmVhdGVqcy5UaWNrZXIuc2V0RlBTKDYwKTtcblxuICBjYW52YXMuc2V0QXR0cmlidXRlKCdzdHlsZScsICdiYWNrZ3JvdW5kLWNvbG9yOiAjMDAwMDAwJyk7XG5cbiAgZHJhd2luZ0NhbnZhcyA9IG5ldyBjcmVhdGVqcy5TaGFwZSgpO1xuICBzdGFnZS5hZGRDaGlsZChkcmF3aW5nQ2FudmFzKTtcblxuICBmYWRlUmVjdCA9IG5ldyBjcmVhdGVqcy5TaGFwZSgpO1xuICBzdGFnZS5hZGRDaGlsZChmYWRlUmVjdCk7XG5cbiAgc2V0Q2hvcmQoY2hvcmRJbmRleCk7XG5cbiAgLy9hdWRpbyBzdHVmZi5cbiAgd2luZG93LkF1ZGlvQ29udGV4dCA9IHdpbmRvdy5BdWRpb0NvbnRleHQgfHwgd2luZG93LndlYmtpdEF1ZGlvQ29udGV4dDtcbiAgaWYoIXdpbmRvdy5BdWRpb0NvbnRleHQpIHtcbiAgICBjb25zb2xlLmxvZygnYXVkaW8gYXBpIG5vdCBhdmFpbGFibGUhJyk7XG4gICAgLy9UT0RPOiBkbyBzb21ldGhpbmcgc21hcnQgdG8gaGFuZGxlIHRoZSBhcGkgbm90IGJlaW5nIGF2YWlsYWJsZS5cbiAgICByZXR1cm47XG4gIH1cbiAgZWxzZSB7XG4gICAgYXVkaW8uY3R4ID0gbmV3IEF1ZGlvQ29udGV4dCgpO1xuICAgIGF1ZGlvLmdlbmVyYXRvciA9IGF1ZGlvLmN0eC5jcmVhdGVTY3JpcHRQcm9jZXNzb3IoY29uZmlnLmJ1ZmZlclNpemUsIDAsIDIpO1xuICAgIGF1ZGlvLmdlbmVyYXRvci5vbmF1ZGlvcHJvY2VzcyA9IHByb2Nlc3NBdWRpbztcbiAgICBhdWRpby5nZW5lcmF0b3IuY29ubmVjdChhdWRpby5jdHguZGVzdGluYXRpb24pO1xuICB9XG5cbiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIG9uUmVzaXplKTtcbiAgb25SZXNpemUoKTtcbiAgc3RhZ2UuYWRkRXZlbnRMaXN0ZW5lcignc3RhZ2Vtb3VzZW1vdmUnLCBvbk1vdXNlTW92ZSk7XG4gIGNyZWF0ZWpzLlRpY2tlci5hZGRFdmVudExpc3RlbmVyKCd0aWNrJywgb25UaWNrKTtcbn1cblxuZnVuY3Rpb24gb25SZXNpemUoKSB7XG4gIGNhbnZhcy53aWR0aCA9IHdpbmRvdy5pbm5lcldpZHRoO1xuICBjYW52YXMuaGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0O1xuICBmYWRlUmVjdC5ncmFwaGljc1xuICAgIC5jbGVhcigpXG4gICAgLmJlZ2luRmlsbChgcmdiYSgwLDAsMCwkeyBjb25maWcuZmFkZUZhY3RvciB9KWApXG4gICAgLnJlY3QoMCwgMCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTtcblxuICBtYXhEb3RDb3VudCA9IE1hdGgucm91bmQoY29uZmlnLm1heERvdEZhY3RvciAqIGNhbnZhcy53aWR0aCAqIGNhbnZhcy5oZWlnaHQpO1xuICBjb25zb2xlLmxvZygnbWF4RG90Q291bnQ6ICcgKyBtYXhEb3RDb3VudCk7XG59XG5cbi8vVE9ETzogc2hvdWxkIGJlIG9rYXkgdG8gbm90IHVzZSBvdXIgZGVsdGEgdGltZSBldmVyeXdoZXJlIGJlY2F1c2Ugb3VyIHRpY2tlclxuLy9tb2RlIGlzIFJBRl9TWU5DSEVELCBidXQgd2Ugc2hvdWxkIGRvIGl0IGFueXdheS5cbmZ1bmN0aW9uIG9uVGljayhldmVudCkge1xuICBjaG9yZENoYW5nZVRpbWVvdXQgLT0gZXZlbnQuZGVsdGE7XG4gIGRvdEFkZFJlbW92ZVRpbWVvdXQgLT0gZXZlbnQuZGVsdGE7XG4gIG5vdGVUcmlnZ2VyVGltZW91dCAtPSBldmVudC5kZWx0YTtcblxuICBjb25zdCBkTW91c2VYID0gc3RhZ2UubW91c2VYIC0gbGFzdE1vdXNlLng7XG4gIGNvbnN0IGRNb3VzZVkgPSBzdGFnZS5tb3VzZVkgLSBsYXN0TW91c2UueTtcblxuICBpZihkb3RBZGRSZW1vdmVUaW1lb3V0IDwgMCkge1xuICAgIGRvdEFkZFJlbW92ZVRpbWVvdXQgPSBjb25maWcuZG90QWRkUmVtb3ZlVGltZW91dDtcbiAgICBpZihkb3RzLmxlbmd0aCA8IG1heERvdENvdW50KXtcbiAgICAgIGFkZERvdCgpO1xuICAgIH1cbiAgICBlbHNlIGlmKGRvdHMubGVuZ3RoID4gbWF4RG90Q291bnQpe1xuICAgICAgZG90cy5wb3AoKTtcbiAgICB9XG4gIH1cblxuICBjb25zdCBnID0gZHJhd2luZ0NhbnZhcy5ncmFwaGljcztcblxuICBnXG4gICAgLmNsZWFyKClcbiAgICAuc2V0U3Ryb2tlU3R5bGUoMSlcbiAgICAuYmVnaW5TdHJva2UoJyNmZmZmZmYnKTtcblxuXG4gIGxldCB3YXNOb3RlUGxheWVkID0gZmFsc2U7XG5cbiAgZm9yKGxldCBkb3Qgb2YgZG90cykge1xuICAgIGcubW92ZVRvKGRvdC54LCBkb3QueSk7XG4gICAgZG90LnggKz0gZG90LnZlbG9jaXR5Lng7XG4gICAgZG90LnkgKz0gZG90LnZlbG9jaXR5Lnk7XG4gICAgZy5saW5lVG8oZG90LngsIGRvdC55KTtcblxuICAgIHdyYXBUb1N0YWdlKGRvdCk7XG5cbiAgICBkb3QuY29udGFjdFRpbWVvdXQgLT0gZXZlbnQuZGVsdGE7XG5cbiAgICBmb3IobGV0IG90aGVyRG90IG9mIGRvdHMpIHtcbiAgICAgIGlmKG90aGVyRG90ID09PSBkb3QpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGR4ID0gZG90LnggLSBvdGhlckRvdC54O1xuICAgICAgY29uc3QgZHkgPSBkb3QueSAtIG90aGVyRG90Lnk7XG4gICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGR4ICogZHggKyBkeSAqIGR5KTtcblxuICAgICAgaWYoZGlzdCA+IGNvbmZpZy5tYXhDb250YWN0RGlzdGFuY2UpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGlmKGRpc3QgPiAwKSB7XG4gICAgICAgIGNvbnN0IHZmID0gY29uZmlnLmNvbnRhY3RWZWxvY2l0eUZhY3RvcjtcbiAgICAgICAgZG90LnZlbG9jaXR5LnggKz0gdmYgKiBkeCAvIGRpc3Q7XG4gICAgICAgIGRvdC52ZWxvY2l0eS55ICs9IHZmICogZHkgLyBkaXN0O1xuICAgICAgICBvdGhlckRvdC52ZWxvY2l0eS54IC09IHZmICogZHggLyBkaXN0O1xuICAgICAgICBvdGhlckRvdC52ZWxvY2l0eS55IC09IHZmICogZHkgLyBkaXN0O1xuICAgICAgfVxuXG4gICAgICBpZihkb3QuY29udGFjdFRpbWVvdXQgPCAwKSB7XG4gICAgICAgIGRvdC5jb250YWN0VGltZW91dCA9IGNvbmZpZy5jb250YWN0VGltZW91dDtcblxuICAgICAgICBnXG4gICAgICAgICAgLm1vdmVUbyhkb3QueCwgZG90LnkpXG4gICAgICAgICAgLmxpbmVUbyhvdGhlckRvdC54LCBvdGhlckRvdC55KTtcblxuICAgICAgICBpZighd2FzTm90ZVBsYXllZCAmJiBub3RlVHJpZ2dlclRpbWVvdXQgPCAwKSB7XG4gICAgICAgICAgd2FzTm90ZVBsYXllZCA9IHRydWU7XG4gICAgICAgICAgbm90ZVRyaWdnZXJUaW1lb3V0ID0gY29uZmlnLm5vdGVUcmlnZ2VyVGltZW91dDtcblxuICAgICAgICAgIGNvbnN0IGF2Z1lQb3MgPSAoZG90LnkgKyBvdGhlckRvdC55KSAvIDI7XG4gICAgICAgICAgbGV0IGluZFNjYWxlID0gTWF0aC5yb3VuZChNYXRoLnJhbmRvbSgpICogMiApICogMiAtIDEgK1xuICAgICAgICAgICAgc2NhbGUubGVuZ3RoIC0gMSAtIE1hdGgucm91bmQoc2NhbGUubGVuZ3RoICogYXZnWVBvcyAvIGNhbnZhcy5oZWlnaHQpO1xuICAgICAgICAgIGluZFNjYWxlID0gY2xhbXAoaW5kU2NhbGUsIDAsIHNjYWxlLmxlbmd0aCAtIDEpO1xuXG4gICAgICAgICAgY29uc3QgYXZnWFBvcyA9IChkb3QueCArIG90aGVyRG90LngpIC8gMjtcbiAgICAgICAgICBjb25zdCBwYW4gPSBhdmdYUG9zIC8gKGNhbnZhcy53aWR0aCAqIDAuNSkgLSAxO1xuXG4gICAgICAgICAgY29uc3QgYXZnWFZlbCA9IChNYXRoLmFicyhkb3QudmVsb2NpdHkueCkgKyBNYXRoLmFicyhvdGhlckRvdC52ZWxvY2l0eS54KSkgLyAyO1xuICAgICAgICAgIGNvbnN0IGF2Z1lWZWwgPSAoTWF0aC5hYnMoZG90LnZlbG9jaXR5LnkpICsgTWF0aC5hYnMob3RoZXJEb3QudmVsb2NpdHkueSkpIC8gMjtcblxuICAgICAgICAgIGxldCBhdmdWZWxvY2l0eSA9IE1hdGguc3FydChhdmdYVmVsICogYXZnWFZlbCArIGF2Z1lWZWwgKiBhdmdZVmVsKTtcbiAgICAgICAgICBhdmdWZWxvY2l0eSA9IGNsYW1wKGF2Z1ZlbG9jaXR5LCAwLCBjb25maWcuZG90U3BlZWRUaHJlc2hvbGQpO1xuXG4gICAgICAgICAgY29uc3Qgdm9sdW1lID0gMC4yICsgMC44ICogKGF2Z1ZlbG9jaXR5IC8gY29uZmlnLmRvdFNwZWVkVGhyZXNob2xkKTtcblxuICAgICAgICAgIGNvbnN0IG5vdGUgPSBzY2FsZVtpbmRTY2FsZV07XG5cbiAgICAgICAgICBhZGRUb25lKG5vdGUsIHBhbiwgdm9sdW1lKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gLy9kb25lIGl0ZXJhdGluZyB0aHJvdWdoIG90aGVyIGRvdHMuXG5cbiAgICBjb25zdCBkWCA9IGRvdC54IC0gc3RhZ2UubW91c2VYO1xuICAgIGNvbnN0IGRZID0gZG90LnkgLSBzdGFnZS5tb3VzZVk7XG5cbiAgICBjb25zdCBkaXN0TW91c2UgPSBNYXRoLnNxcnQoZFggKiBkWCArIGRZICogZFkpO1xuXG4gICAgaWYoZGlzdE1vdXNlIDwgY29uZmlnLm1heE1vdXNlRGlzdGFuY2UpIHtcbiAgICAgIGRvdC52ZWxvY2l0eS54ICs9IDAuMDAxICogKGNvbmZpZy5tYXhNb3VzZURpc3RhbmNlIC0gZGlzdE1vdXNlKSAqIGRNb3VzZVg7XG4gICAgICBkb3QudmVsb2NpdHkueSArPSAwLjAwMSAqIChjb25maWcubWF4TW91c2VEaXN0YW5jZSAtIGRpc3RNb3VzZSkgKiBkTW91c2VZO1xuICAgIH1cblxuICAgIGNvbnN0IHNwZWVkID0gTWF0aC5zcXJ0KGRvdC52ZWxvY2l0eS54ICogZG90LnZlbG9jaXR5LnggKyBkb3QudmVsb2NpdHkueSAqIGRvdC52ZWxvY2l0eS55KTtcbiAgICBpZihzcGVlZCA+IGNvbmZpZy5kb3RTcGVlZFRocmVzaG9sZCkge1xuICAgICAgZG90LnZlbG9jaXR5LnggPSBjb25maWcuZG90U3BlZWRUaHJlc2hvbGQgKiBkb3QudmVsb2NpdHkueCAvIHNwZWVkO1xuICAgICAgZG90LnZlbG9jaXR5LnkgPSBjb25maWcuZG90U3BlZWRUaHJlc2hvbGQgKiBkb3QudmVsb2NpdHkueSAvIHNwZWVkO1xuICAgIH1cblxuICAgIGRvdC52ZWxvY2l0eS54ICo9IGNvbmZpZy5kb3REZWNlbGVyYXRpb247XG4gICAgZG90LnZlbG9jaXR5LnkgKj0gY29uZmlnLmRvdERlY2VsZXJhdGlvbjtcblxuICB9XG5cbiAgbGFzdE1vdXNlLnggPSBzdGFnZS5tb3VzZVg7XG4gIGxhc3RNb3VzZS55ID0gc3RhZ2UubW91c2VZO1xuXG4gIHN0YWdlLnVwZGF0ZSgpO1xufVxuXG5mdW5jdGlvbiBwcm9jZXNzQXVkaW8oZSkge1xuICBjb25zdCBsZWZ0ID0gZS5vdXRwdXRCdWZmZXIuZ2V0Q2hhbm5lbERhdGEoMCk7XG4gIGNvbnN0IHJpZ2h0ID0gZS5vdXRwdXRCdWZmZXIuZ2V0Q2hhbm5lbERhdGEoMSk7XG5cbiAgLy90aGVzZSBidWZmZXJzIGFpbid0IGNsZWFuIVxuICBmb3IobGV0IGkgPSAwOyBpIDwgY29uZmlnLmJ1ZmZlclNpemU7IGkrKykge1xuICAgIGxlZnRbaV0gPSAwO1xuICAgIHJpZ2h0W2ldID0gMDtcbiAgfVxuXG4gIGZvcihsZXQgaiA9IGF1ZGlvLmFjdGl2ZXMubGVuZ3RoIC0gMTsgaiA+PSAwOyBqLS0pIHtcbiAgICBjb25zdCB0b25lID0gYXVkaW8uYWN0aXZlc1tqXTtcbiAgICBmb3IobGV0IGkgPSAwOyBpIDwgY29uZmlnLmJ1ZmZlclNpemU7IGkrKykge1xuICAgICAgaWYodG9uZS5kdXJhdGlvbiA8PSAwKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICAvL2kgZG9uJ3QgcmVhbGx5IGdldCB3aGF0IHRoZXNlIG5leHQgZmV3IHZhbHVlcyBtZWFuLiB0aGV5IGJhc2ljYWxseSBsb29rIGxpa2UgbWFnaWMgbnVtYmVycyB0byBtZS5cbiAgICAgIGNvbnN0IGVudiA9IHRvbmUuZHVyYXRpb24gLyAyMDAwMDtcblxuICAgICAgbGV0IGFtcDtcbiAgICAgIGlmKHRvbmUucGhhc2UgPCAwLjUpIHtcbiAgICAgICAgbGV0IHRtcCA9ICh0b25lLnBoYXNlICogNCAtIDEpO1xuICAgICAgICBhbXAgPSAoMSAtIHRtcCAqIHRtcCkgKiBlbnYgKiBlbnYgKiAwLjU7XG4gICAgICB9XG4gICAgICBlbHNlIHtcbiAgICAgICAgbGV0IHRtcCA9ICh0b25lLnBoYXNlICogNCAtIDMpO1xuICAgICAgICBhbXAgPSAodG1wICogdG1wIC0gMSkgKiBlbnYgKiBlbnYgKiAwLjU7XG4gICAgICB9XG5cbiAgICAgIHRvbmUucGhhc2UgKz0gdG9uZS5mcmVxO1xuXG4gICAgICBpZih0b25lLnBoYXNlID49IDEpIHtcbiAgICAgICAgdG9uZS5waGFzZS0tO1xuICAgICAgfVxuXG4gICAgICBsZWZ0W2ldICs9IGFtcCAqIHRvbmUuZ2Fpbkw7XG4gICAgICByaWdodFtpXSArPSBhbXAgKiB0b25lLmdhaW5SO1xuXG4gICAgICB0b25lLmR1cmF0aW9uLS07XG4gICAgfVxuICAgIGlmKHRvbmUuZHVyYXRpb24gPD0gMCkge1xuICAgICAgYXVkaW8uYWN0aXZlcy5zcGxpY2UoaiwgMSk7XG4gICAgfVxuICB9XG5cbiAgLy9jb25zb2xlLmxvZygnbGVmdDogJyArIChsZWZ0LnJlZHVjZSgocCwgYykgPT4gcCArIGMpIC8gbGVmdC5sZW5ndGgpKTtcbn1cblxuZnVuY3Rpb24gYWRkVG9uZShub3RlLCBwYW4sIHZvbHVtZSkge1xuICBjb25zdCB0b25lID0ge1xuICAgIGR1cmF0aW9uOiAxICogNDQxMDAsXG4gICAgZnJlcTogNDQwICogTWF0aC5wb3coMiwgKG5vdGUgLyAxMikgLSAxKSAvIDQ0MTAwLFxuICAgIHBoYXNlOiAwLFxuICAgIGdhaW5MOiAoMSAtIHBhbikgKiB2b2x1bWUsXG4gICAgZ2FpblI6IChwYW4gKyAxKSAqIHZvbHVtZVxuICB9O1xuXG4gIGF1ZGlvLmFjdGl2ZXMucHVzaCh0b25lKTtcbn1cblxuZnVuY3Rpb24gb25Nb3VzZU1vdmUoZXZlbnQpIHtcbiAgaWYoY2hvcmRDaGFuZ2VUaW1lb3V0IDwgMCkge1xuICAgIGNob3JkSW5kZXggPSAoY2hvcmRJbmRleCArIDEpICUgY29uZmlnLmNob3JkTGlzdC5sZW5ndGg7XG4gICAgc2V0Q2hvcmQoY2hvcmRJbmRleCk7XG4gIH1cblxuICBjaG9yZENoYW5nZVRpbWVvdXQgPSBjb25maWcuY2hvcmRDaGFuZ2VUaW1lb3V0O1xufVxuXG5mdW5jdGlvbiBzZXRDaG9yZChpbmRleCkge1xuICBjb25zdCBjaG9yZE5vdGVzID0gY29uZmlnLmNob3JkTGlzdFtpbmRleF07XG5cbiAgc2NhbGUgPSBbXTtcblxuICBub3Rlcy5mb3JFYWNoKChub3RlLCBpKSA9PiB7XG4gICAgaWYoY2hvcmROb3Rlcy5pbmRleE9mKG5vdGUpICE9PSAtMSkge1xuICAgICAgc2NhbGUucHVzaChpKTtcbiAgICB9XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBhZGREb3QoKSB7XG4gIGNvbnN0IGRvdCA9IG5ldyBjcmVhdGVqcy5Qb2ludChcbiAgICBNYXRoLnJhbmRvbSgpICogY2FudmFzLndpZHRoLFxuICAgIE1hdGgucmFuZG9tKCkgKiBjYW52YXMuaGVpZ2h0XG4gICk7XG5cbiAgZG90LnZlbG9jaXR5ID0gbmV3IGNyZWF0ZWpzLlBvaW50KDAsIDApO1xuICBkb3QuY29udGFjdFRpbWVvdXQgPSBjb25maWcuY29udGFjdFRpbWVvdXQ7XG5cbiAgZG90cy5wdXNoKGRvdCk7XG59XG5cbmZ1bmN0aW9uIHdyYXBUb1N0YWdlKGRvdCkge1xuICBpZiAoZG90LnggPCAwKSB7XG4gICAgZG90LnggKz0gY2FudmFzLndpZHRoO1xuICB9XG4gIGVsc2UgaWYgKGRvdC54ID4gY2FudmFzLndpZHRoKSB7XG4gICAgZG90LnggLT0gY2FudmFzLndpZHRoO1xuICB9XG4gIGlmIChkb3QueSA8IDApIHtcbiAgICBkb3QueSArPSBjYW52YXMuaGVpZ2h0O1xuICB9XG4gIGVsc2UgaWYgKGRvdC55ID4gY2FudmFzLmhlaWdodCkge1xuICAgIGRvdC55IC09IGNhbnZhcy5oZWlnaHQ7XG4gIH1cbn1cblxuZnVuY3Rpb24gY2xhbXAodmFsLCBtaW4sIG1heCkge1xuICByZXR1cm4gTWF0aC5tYXgobWluLCBNYXRoLm1pbihtYXgsIHZhbCkpO1xufVxuXG4iXX0=